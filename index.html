<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงููุธุงู ุงููุญุงุณุจู ุงููุชูุงูู - ุดุฑูุฉ ุงูุนุฑุจ ููุทุงูุฉโก</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #e74c3c; --warning: #f39c12; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f8f9fa; }
        #sidebar { width: 260px; height: 100vh; position: fixed; background: var(--primary); color: white; z-index: 1000; transition: 0.3s; overflow-y: auto; }
        .nav-link { color: #bdc3c7; padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #34495e; transition: 0.2s; }
        .nav-link:hover, .nav-link.active { background: #34495e; color: white; border-right: 5px solid var(--accent); }
        #main-content { margin-right: 260px; padding: 30px; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .card { border: none; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .stat-box { padding: 20px; border-radius: 15px; color: white; }
        .table-res { background: white; border-radius: 12px; padding: 15px; }
        .action-icon { margin: 0 5px; cursor: pointer; opacity: 0.7; }
        .action-icon:hover { opacity: 1; }
        .modal-content { border-radius: 20px; }
        .btn-sm { padding: 0.25rem 0.5rem; }
        @media print {
            .no-print { display: none; }
            .print-only { display: block; }
        }
        .print-only { display: none; }
        .balance-info { font-size: 1.2rem; padding: 10px; background: #e8f4fd; border-radius: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="p-4 text-center border-bottom border-secondary">
        <h5><i class="fas fa-bolt text-warning"></i> ุดุฑูุฉ ุงูุนุฑุจ ููุทุงูุฉ </h5>
    </div>
    <nav class="nav flex-column">
        <div class="nav-link active" onclick="showPage('dashboard')"><i class="fas fa-chart-line ms-2"></i> ุงูุฏุงุดุจูุฑุฏ</div>
        <div class="nav-link" onclick="showPage('setup')"><i class="fas fa-cogs ms-2"></i> ุงูุฅุนุฏุงุฏุงุช ูุงูุชูููุฏ</div>
        <div class="nav-link" onclick="showPage('projectsPage')"><i class="fas fa-project-diagram ms-2"></i> ุงููุดุงุฑูุน</div>
        <div class="nav-link" onclick="showPage('suppliersPage')"><i class="fas fa-truck ms-2"></i> ุงูููุฑุฏูู (ุงูุฃุฑุตุฏุฉ)</div>
        <div class="nav-link" onclick="showPage('vouchers')"><i class="fas fa-money-bill-wave ms-2"></i> ุณูุฏุงุช ุงูุฎุฒููุฉ</div>
        <div class="nav-link" onclick="showPage('expenses')"><i class="fas fa-file-invoice-dollar ms-2"></i> ุชุตููุฉ ูุตุฑููุงุช ุงููุดุงุฑูุน</div>
        <div class="nav-link" onclick="showPage('invoices')"><i class="fas fa-file-contract ms-2"></i> ุงููุณุชุฎูุตุงุช ุงูุดูุฑูุฉ</div>
        <div class="nav-link" onclick="showPage('inventory')"><i class="fas fa-boxes ms-2"></i> ุงููุฎุฒูู ูุตุฑู ุงูููุงุฏ</div>
        <div class="nav-link" onclick="showPage('purchases')"><i class="fas fa-shopping-cart ms-2"></i> ุงููุดุชุฑูุงุช</div>
        <div class="nav-link" onclick="showPage('equipment')"><i class="fas fa-cog ms-2"></i> ุชุฃุฌูุฑ ูุนุฏุงุช</div>
        <div class="nav-link" onclick="showPage('supervisorStatement')"><i class="fas fa-user-tie ms-2"></i> ูุดู ุญุณุงุจ ูุดุฑู</div>
        <div class="nav-link" onclick="showPage('projectCosts')"><i class="fas fa-calculator ms-2"></i> ุชูุงููู ุงููุดุงุฑูุน</div>
        <div class="nav-link" onclick="showPage('equipmentStatement')"><i class="fas fa-chart-pie ms-2"></i> ูุดู ุญุณุงุจ ูุนุฏุฉ</div>
        <div class="nav-link" onclick="showPage('reports')"><i class="fas fa-print ms-2"></i> ุงูุชูุงุฑูุฑ ูุงูุจุญุซ</div>
    </nav>
</div>

<div id="main-content">
    <!-- ุฏุงุดุจูุฑุฏ -->
    <div id="dashboard" class="page-section active">
        <h3 class="mb-4">ููุฎุต ุงูุฃุฏุงุก ุงููุงูู</h3>
        <div class="row g-4 mb-4" id="stats-summary"></div>
        <div class="row">
            <div class="col-md-8">
                <div class="card p-3">
                    <canvas id="cashChart" height="200"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>ุฃุญุฏุซ ุงูุนูููุงุช</h5>
                    <table class="table table-sm mt-2">
                        <tbody id="latest-transactions"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ุงูุฅุนุฏุงุฏุงุช (ูุน ุฃุฒุฑุงุฑ ุงููุณุฎ ุงูุงุญุชูุงุทู) -->
    <div id="setup" class="page-section">
        <h3 class="mb-4">ุชุนุฑูู ุงูุญุณุงุจุงุช ูุงูุจููุฏ</h3>
        <div class="row g-4">
            <div class="col-md-3">
                <div class="card p-3">
                    <h6><i class="fas fa-user-tie"></i> ุงููุดุฑููู</h6>
                    <div class="d-flex gap-2 mb-2">
                        <input type="text" id="s-sup" class="form-control" placeholder="ุงุณู ุงููุดุฑู">
                        <button class="btn btn-primary btn-sm" onclick="addItem('supervisors','s-sup')"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="sup-list" class="small"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h6><i class="fas fa-truck"></i> ุงูููุฑุฏูู</h6>
                    <div class="d-flex gap-2 mb-2">
                        <input type="text" id="s-supp" class="form-control" placeholder="ุงุณู ุงูููุฑุฏ">
                        <button class="btn btn-success btn-sm" onclick="addItem('suppliers','s-supp')"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="supp-list" class="small"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h6><i class="fas fa-list"></i> ุจููุฏ ุงููุตุงุฑูู</h6>
                    <div class="d-flex gap-2 mb-2">
                        <input type="text" id="s-item" class="form-control" placeholder="ุญูุฑุ ูุงุจูุงุช..">
                        <button class="btn btn-info btn-sm text-white" onclick="addItem('expenseItems','s-item')"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="item-list" class="small"></div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card p-3">
                    <h6><i class="fas fa-warehouse"></i> ุงููุฎุงุฒู</h6>
                    <div class="d-flex gap-2 mb-2">
                        <input type="text" id="s-wh-code" class="form-control" placeholder="ููุฏ ุงููุฎุฒู">
                        <input type="text" id="s-wh-name" class="form-control" placeholder="ุงุณู ุงููุฎุฒู">
                        <button class="btn btn-secondary btn-sm" onclick="addWarehouse()"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="warehouse-list" class="small"></div>
                </div>
            </div>
            <div class="col-md-3 mt-3">
                <div class="card p-3">
                    <h6><i class="fas fa-cog"></i> ุฃููุงุน ุงููุนุฏุงุช</h6>
                    <div class="d-flex gap-2 mb-2">
                        <input type="text" id="s-equip" class="form-control" placeholder="ูุซุงู: ุญูุงุฑุ ุดุงููุด">
                        <button class="btn btn-warning btn-sm" onclick="addItem('equipmentTypes','s-equip')"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="equip-list" class="small"></div>
                </div>
            </div>
            <div class="col-md-3 mt-3">
                <div class="card p-3">
                    <h6><i class="fas fa-wrench"></i> ุชูุงููู ุชุดุบูู</h6>
                    <div class="d-flex gap-2 mb-2">
                        <input type="text" id="s-op-cost" class="form-control" placeholder="ุฃุฌูุฑุ ุตูุงูุฉุ ...">
                        <button class="btn btn-secondary btn-sm" onclick="addItem('operationalCostTypes','s-op-cost')"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="op-cost-list" class="small"></div>
                </div>
            </div>
            <div class="col-md-3 mt-3">
                <div class="card p-3">
                    <h6><i class="fas fa-percent"></i> ุฃููุงุน ุงูุถุฑุงุฆุจ</h6>
                    <div class="d-flex gap-2 mb-2">
                        <input type="text" id="s-tax" class="form-control" placeholder="VAT, TDS, ...">
                        <button class="btn btn-danger btn-sm" onclick="addItem('taxTypes','s-tax')"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="tax-list" class="small"></div>
                </div>
            </div>
        </div>
        <!-- ุฃุฒุฑุงุฑ ุงููุณุฎ ุงูุงุญุชูุงุทู -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card p-3">
                    <h5>ุงููุณุฎ ุงูุงุญุชูุงุทู</h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="exportData()"><i class="fas fa-download"></i> ุชุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
                        <button class="btn btn-warning" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> ุงุณุชูุฑุงุฏ ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ุตูุญุฉ ุงููุดุงุฑูุน -->
    <div id="projectsPage" class="page-section">
        <h3 class="mb-4">ุฅุฏุงุฑุฉ ุงููุดุงุฑูุน</h3>
        <div class="card p-3">
            <div class="d-flex justify-content-between mb-3">
                <h5>ูุงุฆูุฉ ุงููุดุงุฑูุน</h5>
                <button class="btn btn-primary" onclick="openProjectModal()"><i class="fas fa-plus"></i> ุฅุถุงูุฉ ูุดุฑูุน</button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ุฑูู ุงููุดุฑูุน</th>
                            <th>ุงุณู ุงููุดุฑูุน/ุงูุนููู</th>
                            <th>ุงูููุงูู</th>
                            <th>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</th>
                            <th>ูููุฉ ุงููุดุฑูุน (ุฌููู)</th>
                            <th>ููุน ุงูุนูู</th>
                            <th>ุญุงูุฉ ุงููุดุฑูุน</th>
                            <th>ููุงุญุธุงุช</th>
                            <th>ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="projects-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ุตูุญุฉ ุงูููุฑุฏูู -->
    <div id="suppliersPage" class="page-section">
        <h3 class="mb-4">ุฅุฏุงุฑุฉ ุงูููุฑุฏูู ูุญุณุงุจุงุชูู</h3>
        <div class="card p-3">
            <div class="d-flex justify-content-between mb-3">
                <h5>ูุงุฆูุฉ ุงูููุฑุฏูู ูุงูุฃุฑุตุฏุฉ</h5>
                <button class="btn btn-success" onclick="addSupplierFromPage()"><i class="fas fa-plus"></i> ุฅุถุงูุฉ ููุฑุฏ</button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ุงุณู ุงูููุฑุฏ</th>
                            <th>ุฅุฌูุงูู ุงููุดุชุฑูุงุช (ูุฏูู) ุฌ.ู</th>
                            <th>ุฅุฌูุงูู ุงููุฏููุน (ุฏุงุฆู) ุฌ.ู</th>
                            <th>ุงูุฑุตูุฏ ุงูุญุงูู (ูุฏูู - ุฏุงุฆู)</th>
                            <th>ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="suppliers-table-body"></tbody>
                </table>
            </div>
            <p class="text-muted small">* ุงููุดุชุฑูุงุช ุชุญุณุจ ูู ุงููุณุชุฎูุตุงุช + ููุงุชูุฑ ุงูุดุฑุงุก. ุงููุฏููุนุงุช ูู ุณูุฏุงุช "ุณุฏุงุฏ ููุฑุฏ".</p>
        </div>
    </div>

    <!-- ุณูุฏุงุช ุงูุฎุฒููุฉ (ุจุฌููุน ุงูุฃููุงุน) -->
    <div id="vouchers" class="page-section">
        <h3 class="mb-4">ุฅุฏุงุฑุฉ ุงูุฎุฒููุฉ</h3>
        <div class="card p-4">
            <h5>ุฅุถุงูุฉ ุณูุฏ ุฌุฏูุฏ</h5>
            <div class="row g-3">
                <div class="col-md-2"><label>ุงูุชุงุฑูุฎ</label><input type="date" id="v-date" class="form-control"></div>
                <div class="col-md-2"><label>ุงูููุน</label>
                    <select id="v-type" class="form-select" onchange="updateVoucherPersonSelect()">
                        <option value="ูุจุถ">๐ฅ ูุจุถ</option>
                        <option value="ุตุฑู ุนูุฏุฉ">๐ฐ ุตุฑู ุนูุฏุฉ</option>
                        <option value="ุณุฏุงุฏ ููุฑุฏ">๐ณ ุณุฏุงุฏ ููุฑุฏ</option>
                        <option value="ูุตุฑูู ุนุงู">๐ธ ูุตุฑูู ุนุงู</option>
                        <option value="ุณุฏุงุฏ ูุชููุน">๐งพ ุณุฏุงุฏ ูุชููุน</option>
                        <option value="ุณุฏุงุฏ ุฅูุฌุงุฑ">๐ข ุณุฏุงุฏ ุฅูุฌุงุฑ</option>
                        <option value="ุณุฏุงุฏ ููุฑุจุงุก">โก ุณุฏุงุฏ ููุฑุจุงุก</option>
                        <option value="ุณุฏุงุฏ ูุนุฏุฉ">๐๏ธ ุณุฏุงุฏ ูุนุฏุฉ</option>
                    </select>
                </div>
                <div class="col-md-2"><label>ุงูุฌูุฉ</label><select id="v-person" class="form-select"></select></div>
                <div class="col-md-2"><label>ุงููุดุฑูุน</label><select id="v-project" class="form-select"></select></div>
                <div class="col-md-2"><label>ุงููุจูุบ (ุฌ.ู)</label><input type="number" id="v-amount" class="form-control" min="0"></div>
                <div class="col-md-2"><label>ุงูุจูุงู</label><input type="text" id="v-desc" class="form-control"></div>
                <div class="col-12"><button class="btn btn-primary w-100" onclick="addVoucher()"><i class="fas fa-save"></i> ุญูุธ ุงูุณูุฏ</button></div>
            </div>
        </div>
        <div class="card p-3 mt-3">
            <h5>ุขุฎุฑ ุงูุณูุฏุงุช</h5>
            <div style="max-height:300px; overflow-y:auto">
                <table class="table table-sm">
                    <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงูุฌูุฉ</th><th>ุงููุดุฑูุน</th><th>ุงููุจูุบ</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                    <tbody id="vouchers-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ุชุตููุฉ ูุตุฑููุงุช ุงููุดุงุฑูุน -->
    <div id="expenses" class="page-section">
        <h3 class="mb-4">ุชุตููุฉ ุงูุนููุฏ / ุชุณุฌูู ูุตุฑููุงุช ุงููุดุฑูุน (ูุชุนุฏุฏ ุงูุจููุฏ)</h3>
        <div class="card p-4 border-start border-5 border-danger">
            <div class="row g-3">
                <div class="col-md-3"><label>ุงูุชุงุฑูุฎ</label><input type="date" id="e-date" class="form-control"></div>
                <div class="col-md-3"><label>ุงููุดุฑู</label>
                    <select id="e-sup" class="form-select" onchange="updateSupervisorBalance()">
                        <option value="">-- ุงุฎุชุฑ ุงููุดุฑู --</option>
                    </select>
                </div>
                <div class="col-md-3"><label>ุงููุดุฑูุน</label><select id="e-proj" class="form-select"></select></div>
                <div class="col-md-3"><div id="supervisor-balance" class="balance-info">ุงูุนูุฏุฉ ุงูุญุงููุฉ: 0 ุฌ.ู</div></div>
            </div>
            <hr>
            <h5>ุจููุฏ ุงููุตุฑููุงุช</h5>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>ุจูุฏ ุงููุตุฑูู</th>
                        <th>ุงููุจูุบ (ุฌ.ู)</th>
                        <th>ุงูุจูุงู</th>
                        <th style="width:50px"></th>
                    </tr>
                </thead>
                <tbody id="expense-items-container">
                    <!-- ุตููู ุฏููุงููููุฉ -->
                </tbody>
            </table>
            <button class="btn btn-sm btn-secondary mb-2" onclick="addExpenseRow()"><i class="fas fa-plus"></i> ุฅุถุงูุฉ ุจูุฏ</button>
            <div class="row mt-2">
                <div class="col-md-4">
                    <strong>ุฅุฌูุงูู ุงููุตุฑููุงุช: </strong>
                    <input type="text" id="expense-total" class="form-control" readonly value="0">
                </div>
                <div class="col-md-8">
                    <button class="btn btn-danger w-100" onclick="addExpense()"><i class="fas fa-check-circle"></i> ุชุตููุฉ ูู ุงูุนูุฏุฉ</button>
                </div>
            </div>
        </div>
        <div class="card p-3 mt-3">
            <h5>ุขุฎุฑ ุงููุตุฑููุงุช</h5>
            <div style="max-height:300px; overflow-y:auto">
                <table class="table table-sm">
                    <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงููุดุฑู</th><th>ุงููุดุฑูุน</th><th>ุงูุจูุฏ</th><th>ุงููุจูุบ</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                    <tbody id="expenses-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ุงููุณุชุฎูุตุงุช ุงูุดูุฑูุฉ -->
    <div id="invoices" class="page-section">
        <h3 class="mb-4">ุฅุฏุงุฑุฉ ุงููุณุชุฎูุตุงุช ุงูุดูุฑูุฉ</h3>
        <div class="card p-4 border-start border-5 border-success">
            <div class="row g-3">
                <div class="col-md-2"><label>ุงูุชุงุฑูุฎ</label><input type="date" id="i-date" class="form-control"></div>
                <div class="col-md-2"><label>ุงููุดุฑูุน</label><select id="i-proj" class="form-select"></select></div>
                <div class="col-md-2"><label>ุฑูู ุงููุณุชุฎูุต</label><input type="text" id="i-no" class="form-control"></div>
                <div class="col-md-2"><label>ูููุฉ ุงูุฃุนูุงู</label><input type="number" id="i-val" class="form-control" min="0"></div>
                <div class="col-md-2"><label>ุฎุตู ุชุฃููู</label><input type="number" id="i-tamin" class="form-control" value="0" step="0.01"></div>
                <div class="col-md-2"><label>ุถุฑุงุฆุจ</label><input type="number" id="i-tax" class="form-control" value="0" step="0.01"></div>
                <div class="col-md-2"><label>ุงูุตุงูู</label><input type="number" id="i-net" class="form-control" readonly></div>
                <div class="col-md-2"><label>ุญุงูุฉ ุงูุฏูุน</label><select id="i-paid" class="form-select"><option value="ุบูุฑ ูุฏููุน">โ ุบูุฑ ูุฏููุน</option><option value="ูุฏููุน">โ ูุฏููุน</option></select></div>
                <div class="col-12"><button class="btn btn-success w-100" onclick="addInvoice()"><i class="fas fa-file-invoice"></i> ุงุนุชูุงุฏ ุงููุณุชุฎูุต</button></div>
            </div>
        </div>
        <div class="card p-3 mt-3">
            <h5>ุงููุณุชุฎูุตุงุช ุงูุณุงุจูุฉ</h5>
            <div style="max-height:300px; overflow-y:auto">
                <table class="table table-sm">
                    <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงููุดุฑูุน</th><th>ุฑูู ุงููุณุชุฎูุต</th><th>ุงูุตุงูู</th><th>ุงูุญุงูุฉ</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                    <tbody id="invoices-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ุงููุฎุฒูู ูุตุฑู ุงูููุงุฏ -->
    <div id="inventory" class="page-section">
        <h3 class="mb-4">ุงููุฎุฒูู ูุฅุฏุงุฑุฉ ุงูููุงุฏ</h3>
        <div class="row">
            <div class="col-md-6">
                <div class="card p-3">
                    <h5>ุฅุถุงูุฉ ุตูู ุฌุฏูุฏ</h5>
                    <div class="row g-2">
                        <div class="col-md-6"><input type="text" id="new-item-code" class="form-control" placeholder="ููุฏ ุงูุตูู"></div>
                        <div class="col-md-6"><input type="text" id="new-item-name" class="form-control" placeholder="ุงุณู ุงูุตูู"></div>
                        <div class="col-md-4"><input type="text" id="new-item-unit" class="form-control" placeholder="ุงููุญุฏุฉ"></div>
                        <div class="col-md-4"><input type="number" id="new-item-price" class="form-control" placeholder="ุงูุณุนุฑ" min="0" step="0.01"></div>
                        <div class="col-md-4"><input type="number" id="new-item-qty" class="form-control" placeholder="ุงููููุฉ" min="0" step="1"></div>
                        <div class="col-md-12">
                            <select id="new-item-warehouse" class="form-select">
                                <option value="">ุงุฎุชุฑ ุงููุฎุฒู</option>
                            </select>
                        </div>
                        <div class="col-12"><button class="btn btn-primary w-100" onclick="addInventoryItem()"><i class="fas fa-plus"></i> ุฅุถุงูุฉ</button></div>
                    </div>
                    <h5 class="mt-4">ุงูุฃุตูุงู ุงูุญุงููุฉ</h5>
                    <div style="max-height:300px; overflow-y:auto">
                        <table class="table table-sm">
                            <thead><tr><th>ุงูููุฏ</th><th>ุงูุตูู</th><th>ุงููุญุฏุฉ</th><th>ุงูุณุนุฑ</th><th>ุงููููุฉ</th><th>ุงููุฎุฒู</th><th>ุงูุฅุฌุฑุงุกุงุช</th></tr></thead>
                            <tbody id="inventory-items-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-3 border-start border-5 border-info">
                    <h5>ุตุฑู ููุงุฏ ููุดุฑู</h5>
                    <div class="row g-2">
                        <div class="col-md-6"><label>ุงูุชุงุฑูุฎ</label><input type="date" id="issue-date" class="form-control"></div>
                        <div class="col-md-6"><label>ุงููุดุฑู</label><select id="issue-sup" class="form-select"></select></div>
                        <div class="col-md-6"><label>ุงููุดุฑูุน</label><select id="issue-proj" class="form-select"></select></div>
                        <div class="col-md-6"><label>ูุฎุฒู ุงูุตุฑู</label><select id="issue-warehouse" class="form-select" onchange="loadItemsForWarehouse()"></select></div>
                        <div class="col-md-6"><label>ุงูุตูู</label><select id="issue-item" class="form-select" onchange="updateItemPrice()"></select></div>
                        <div class="col-md-3"><label>ุงููููุฉ</label><input type="number" id="issue-qty" class="form-control" min="1" step="1" oninput="calculateIssueTotal()"></div>
                        <div class="col-md-3"><label>ุงูุณุนุฑ</label><input type="number" id="issue-price" class="form-control" readonly></div>
                        <div class="col-md-3"><label>ุงูุฅุฌูุงูู</label><input type="number" id="issue-total" class="form-control" readonly></div>
                        <div class="col-md-12"><label>ุจูุงู</label><input type="text" id="issue-desc" class="form-control" placeholder="ุงุฎุชูุงุฑู"></div>
                        <div class="col-12 mt-2"><button class="btn btn-info w-100" onclick="addMaterialIssue()"><i class="fas fa-truck"></i> ุชุณุฌูู ุงูุตุฑู</button></div>
                    </div>
                </div>
                <div class="card p-3 mt-3">
                    <h5>ุขุฎุฑ ุนูููุงุช ุงูุตุฑู <button class="btn btn-sm btn-outline-secondary" onclick="printWarehouseBalance()"><i class="fas fa-print"></i> ุทุจุงุนุฉ ูุดู ุงูุฑุตูุฏ</button></h5>
                    <div style="max-height:200px; overflow-y:auto">
                        <table class="table table-sm">
                            <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงููุดุฑู</th><th>ุงููุดุฑูุน</th><th>ุงูุตูู</th><th>ุงููููุฉ</th><th>ุงูุฅุฌูุงูู</th><th>ุทุจุงุนุฉ</th></tr></thead>
                            <tbody id="issues-list"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ุตูุญุฉ ุงููุดุชุฑูุงุช -->
    <div id="purchases" class="page-section">
        <h3 class="mb-4">ุฅุฏุงุฑุฉ ููุงุชูุฑ ุงูุดุฑุงุก</h3>
        <div class="card p-4 border-start border-5 border-primary">
            <h5>ุฅุถุงูุฉ ูุงุชูุฑุฉ ุดุฑุงุก ุฌุฏูุฏุฉ</h5>
            <div class="row g-3">
                <div class="col-md-2"><label>ุงูุชุงุฑูุฎ</label><input type="date" id="p-date" class="form-control"></div>
                <div class="col-md-3"><label>ุงูููุฑุฏ</label><select id="p-supplier" class="form-select"><option value="">-- ุงุฎุชุฑ ุงูููุฑุฏ --</option></select></div>
                <div class="col-md-3"><label>ุงููุฎุฒู ุงููุณุชูู</label><select id="p-warehouse" class="form-select" onchange="loadPurchaseItems()"><option value="">-- ุงุฎุชุฑ ุงููุฎุฒู --</option></select></div>
                <div class="col-md-2"><label>ุฑูู ุงููุงุชูุฑุฉ</label><input type="text" id="p-inv-no" class="form-control" placeholder="ุงุฎุชูุงุฑู"></div>
                <div class="col-md-2"><label>ุฑุงุจุท ุงูุชุญููู</label><input type="url" id="p-file-url" class="form-control" placeholder="https://..."></div>
            </div>
            <hr>
            <h5>ุงูุฃุตูุงู ุงููุดุชุฑุงุฉ</h5>
            <table class="table table-bordered">
                <thead><tr><th>ุงูุตูู</th><th>ุงููุญุฏุฉ</th><th>ุงููููุฉ</th><th>ุณุนุฑ ุงูุดุฑุงุก</th><th>ุงูุฅุฌูุงูู</th><th style="width:50px"></th></tr></thead>
                <tbody id="purchase-items-container"></tbody>
            </table>
            <button class="btn btn-sm btn-secondary mb-2" onclick="addPurchaseRow()"><i class="fas fa-plus"></i> ุฅุถุงูุฉ ุตูู</button>
            <div class="row mt-2">
                <div class="col-md-4"><strong>ุฅุฌูุงูู ุงููุงุชูุฑุฉ: </strong><input type="text" id="purchase-total" class="form-control" readonly value="0"></div>
                <div class="col-md-4"><label>ููุงุญุธุงุช</label><input type="text" id="p-notes" class="form-control" placeholder="ุงุฎุชูุงุฑู"></div>
                <div class="col-md-4"><button class="btn btn-primary w-100" onclick="addPurchaseInvoice()"><i class="fas fa-save"></i> ุญูุธ ูุงุชูุฑุฉ ุงูุดุฑุงุก</button></div>
            </div>
        </div>
        <div class="card p-3 mt-3">
            <h5>ููุงุชูุฑ ุงูุดุฑุงุก ุงููุณุฌูุฉ</h5>
            <div style="max-height:400px; overflow-y:auto">
                <table class="table table-sm">
                    <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุฑุฏ</th><th>ุงููุฎุฒู</th><th>ุฑูู ุงููุงุชูุฑุฉ</th><th>ุงูุฅุฌูุงูู</th><th>ุฑุงุจุท ุงูุชุญููู</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                    <tbody id="purchases-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ุตูุญุฉ ุชุฃุฌูุฑ ุงููุนุฏุงุช (ูุน ูููุน ุงูุชุดุบูู) -->
    <div id="equipment" class="page-section">
        <h3 class="mb-4">ุชุฃุฌูุฑ ุงููุนุฏุงุช ุจุงูุณุงุนุฉ</h3>
        <div class="card p-4 border-start border-5 border-warning">
            <h5>ุชุณุฌูู ุนูููุฉ ุชุฃุฌูุฑ</h5>
            <div class="row g-3">
                <div class="col-md-2"><label>ุงูุชุงุฑูุฎ</label><input type="date" id="eq-date" class="form-control"></div>
                <div class="col-md-3"><label>ุงููุดุฑู</label><select id="eq-supervisor" class="form-select"><option value="">-- ุงุฎุชุฑ ุงููุดุฑู --</option></select></div>
                <div class="col-md-3"><label>ููุน ุงููุนุฏุฉ</label><select id="eq-type" class="form-select"><option value="">-- ุงุฎุชุฑ ุงููุนุฏุฉ --</option></select></div>
                <div class="col-md-2"><label>ุนุฏุฏ ุงูุณุงุนุงุช</label><input type="number" id="eq-hours" class="form-control" min="0.5" step="0.5" oninput="calculateEquipmentTotal()"></div>
                <div class="col-md-2"><label>ุณุนุฑ ุงูุณุงุนุฉ</label><input type="number" id="eq-rate" class="form-control" min="0" step="0.01" oninput="calculateEquipmentTotal()"></div>
                <div class="col-md-2"><label>ุงูุฅุฌูุงูู</label><input type="number" id="eq-total" class="form-control" readonly></div>
                <div class="col-md-3"><label>ุงููุดุฑูุน (ุงุฎุชูุงุฑู)</label><select id="eq-project" class="form-select"><option value="">-- ุนุงู --</option></select></div>
                <div class="col-md-3"><label>ูููุน ุงูุชุดุบูู</label><input type="text" id="eq-location" class="form-control" placeholder="ูููุน ุงูุนูู"></div>
                <div class="col-md-3"><label>ููุงุญุธุงุช</label><input type="text" id="eq-notes" class="form-control" placeholder="ุงุฎุชูุงุฑู"></div>
                <div class="col-12"><button class="btn btn-warning w-100" onclick="addEquipmentRental()"><i class="fas fa-save"></i> ุชุณุฌูู ุงูุชุฃุฌูุฑ</button></div>
            </div>
        </div>
        <div class="card p-3 mt-3">
            <h5>ุนูููุงุช ุงูุชุฃุฌูุฑ ุงููุณุฌูุฉ</h5>
            <div style="max-height:400px; overflow-y:auto">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงููุดุฑู</th>
                            <th>ุงููุนุฏุฉ</th>
                            <th>ุงูุณุงุนุงุช</th>
                            <th>ุงูุณุนุฑ/ุณุงุนุฉ</th>
                            <th>ุงูุฅุฌูุงูู</th>
                            <th>ุงููุดุฑูุน</th>
                            <th>ุงููููุน</th>
                            <th>ุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody id="equipment-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ุตูุญุฉ ูุดู ุญุณุงุจ ูุดุฑู -->
    <div id="supervisorStatement" class="page-section">
        <h3 class="mb-4">ูุดู ุญุณุงุจ ูุดุฑู (ุนูุฏ ููุตุฑููุงุช)</h3>
        <div class="card p-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <label>ุงุฎุชุฑ ุงููุดุฑู</label>
                    <select id="stmt-supervisor" class="form-select">
                        <option value="">-- ุงุฎุชุฑ ุงููุดุฑู --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>ูู ุชุงุฑูุฎ</label>
                    <input type="date" id="stmt-from" class="form-control">
                </div>
                <div class="col-md-3">
                    <label>ุฅูู ุชุงุฑูุฎ</label>
                    <input type="date" id="stmt-to" class="form-control">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="generateSupervisorStatement()">ุนุฑุถ</button>
                </div>
            </div>
        </div>

        <div id="statement-result" style="display: none;">
            <div class="card p-3 mt-3">
                <div class="d-flex justify-content-between">
                    <h5>ูุดู ุญุณุงุจ: <span id="stmt-sup-name"></span></h5>
                    <button class="btn btn-sm btn-secondary" onclick="printSupervisorStatement()"><i class="fas fa-print"></i> ุทุจุงุนุฉ</button>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <strong>ุฅุฌูุงูู ุงูุนูุฏ:</strong> <span id="stmt-total-received">0</span> ุฌ.ู
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-warning">
                            <strong>ุฅุฌูุงูู ุงููุตุฑููุงุช:</strong> <span id="stmt-total-expenses">0</span> ุฌ.ู
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-success">
                            <strong>ุงูุฑุตูุฏ:</strong> <span id="stmt-balance">0</span> ุฌ.ู
                        </div>
                    </div>
                </div>
                <h6 class="mt-3">ุชูุงุตูู ุงูุญุฑูุงุช</h6>
                <div style="max-height:400px; overflow-y:auto">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>ุงูุชุงุฑูุฎ</th>
                                <th>ุงูููุน</th>
                                <th>ุงููุดุฑูุน</th>
                                <th>ุงูุจูุงู</th>
                                <th>ุงููุจูุบ</th>
                            </tr>
                        </thead>
                        <tbody id="stmt-details-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ุตูุญุฉ ุชูุงููู ุงููุดุงุฑูุน -->
    <div id="projectCosts" class="page-section">
        <h3 class="mb-4">ุชูุงููู ุงููุดุงุฑูุน (ูุตุฑููุงุช + ุชุดุบูู + ุถุฑุงุฆุจ)</h3>
        <div class="row">
            <div class="col-md-4">
                <div class="card p-3">
                    <h5>ุฅุถุงูุฉ ุชูููุฉ ุชุดุบูู</h5>
                    <div class="mb-2">
                        <label>ุงููุดุฑูุน</label>
                        <select id="pc-project" class="form-select">
                            <option value="">-- ุงุฎุชุฑ ุงููุดุฑูุน --</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>ููุน ุงูุชูููุฉ</label>
                        <select id="pc-cost-type" class="form-select">
                            <option value="">-- ุงุฎุชุฑ --</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>ุงูุชุงุฑูุฎ</label>
                        <input type="date" id="pc-date" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>ุงููุจูุบ (ุฌ.ู)</label>
                        <input type="number" id="pc-amount" class="form-control" min="0" step="0.01">
                    </div>
                    <div class="mb-2">
                        <label>ุงูุจูุงู</label>
                        <input type="text" id="pc-desc" class="form-control" placeholder="ุงุฎุชูุงุฑู">
                    </div>
                    <button class="btn btn-primary w-100" onclick="addOperationalCost()">ุฅุถุงูุฉ ุชูููุฉ ุชุดุบูู</button>
                </div>
                <div class="card p-3 mt-3">
                    <h5>ุฅุถุงูุฉ ุถุฑูุจุฉ</h5>
                    <div class="mb-2">
                        <label>ุงููุดุฑูุน</label>
                        <select id="tax-project" class="form-select">
                            <option value="">-- ุงุฎุชุฑ ุงููุดุฑูุน --</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>ููุน ุงูุถุฑูุจุฉ</label>
                        <select id="tax-type" class="form-select">
                            <option value="">-- ุงุฎุชุฑ --</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label>ุงูุชุงุฑูุฎ</label>
                        <input type="date" id="tax-date" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>ูุณุจุฉ ุงูุถุฑูุจุฉ (%)</label>
                        <input type="number" id="tax-rate" class="form-control" min="0" step="0.01" value="14">
                    </div>
                    <div class="mb-2">
                        <label>ุงูุฃุณุงุณ (ุงููุจูุบ ุงูุฎุงุถุน ููุถุฑูุจุฉ)</label>
                        <input type="number" id="tax-base" class="form-control" min="0" step="0.01">
                    </div>
                    <div class="mb-2">
                        <label>ุงููุจูุบ (ูุญุณุจ ุชููุงุฆูุงู)</label>
                        <input type="number" id="tax-amount" class="form-control" readonly>
                    </div>
                    <div class="mb-2">
                        <label>ุงูุจูุงู</label>
                        <input type="text" id="tax-desc" class="form-control" placeholder="ุงุฎุชูุงุฑู">
                    </div>
                    <button class="btn btn-danger w-100" onclick="addTax()">ุฅุถุงูุฉ ุถุฑูุจุฉ</button>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card p-3">
                    <h5>ุชูุงููู ุงููุดุงุฑูุน ุงูุญุงููุฉ</h5>
                    <div class="mb-3">
                        <select id="pc-filter-project" class="form-select" onchange="renderProjectCosts()">
                            <option value="">ุฌููุน ุงููุดุงุฑูุน</option>
                        </select>
                    </div>
                    <div style="max-height:500px; overflow-y:auto">
                        <table class="table table-sm table-bordered">
                            <thead>
                                <tr>
                                    <th>ุงูุชุงุฑูุฎ</th>
                                    <th>ุงููุดุฑูุน</th>
                                    <th>ุงูููุน</th>
                                    <th>ุงูุชูุงุตูู</th>
                                    <th>ุงููุจูุบ</th>
                                    <th>ุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody id="project-costs-body"></tbody>
                            <tfoot>
                                <tr>
                                    <th colspan="4" class="text-start">ุงูุฅุฌูุงูู</th>
                                    <th id="total-project-costs">0</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ุตูุญุฉ ูุดู ุญุณุงุจ ูุนุฏุฉ -->
    <div id="equipmentStatement" class="page-section">
        <h3 class="mb-4">ูุดู ุญุณุงุจ ูุนุฏุฉ (ูุฏูู / ุฏุงุฆู)</h3>
        <div class="card p-4">
            <div class="row g-3">
                <div class="col-md-4">
                    <label>ุงุฎุชุฑ ุงููุนุฏุฉ</label>
                    <select id="stmt-equipment" class="form-select">
                        <option value="">-- ุงุฎุชุฑ ุงููุนุฏุฉ --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label>ูู ุชุงุฑูุฎ</label>
                    <input type="date" id="stmt-eq-from" class="form-control">
                </div>
                <div class="col-md-3">
                    <label>ุฅูู ุชุงุฑูุฎ</label>
                    <input type="date" id="stmt-eq-to" class="form-control">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="generateEquipmentStatement()">ุนุฑุถ</button>
                </div>
            </div>
        </div>

        <div id="equipment-statement-result" style="display: none;">
            <div class="card p-3 mt-3">
                <div class="d-flex justify-content-between">
                    <h5>ูุดู ุญุณุงุจ: <span id="stmt-eq-name"></span></h5>
                    <button class="btn btn-sm btn-secondary" onclick="printEquipmentStatement()"><i class="fas fa-print"></i> ุทุจุงุนุฉ</button>
                </div>
                <div class="row mt-2">
                    <div class="col-md-4">
                        <div class="alert alert-info">
                            <strong>ุฅุฌูุงูู ุงููุฏูู (ุชุฃุฌูุฑ):</strong> <span id="stmt-eq-total-debit">0</span> ุฌ.ู
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-warning">
                            <strong>ุฅุฌูุงูู ุงูุฏุงุฆู (ุณุฏุงุฏ):</strong> <span id="stmt-eq-total-credit">0</span> ุฌ.ู
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-success">
                            <strong>ุงูุฑุตูุฏ:</strong> <span id="stmt-eq-balance">0</span> ุฌ.ู
                        </div>
                    </div>
                </div>
                <h6 class="mt-3">ุชูุงุตูู ุงูุญุฑูุงุช</h6>
                <div style="max-height:400px; overflow-y:auto">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>ุงูุชุงุฑูุฎ</th>
                                <th>ุงูููุน</th>
                                <th>ุงููุดุฑู</th>
                                <th>ุงููุดุฑูุน</th>
                                <th>ุงููููุน</th>
                                <th>ุงูุณุงุนุงุช</th>
                                <th>ุณุนุฑ/ุณุงุนุฉ</th>
                                <th>ุงููุจูุบ</th>
                                <th>ุงูุฑุตูุฏ</th>
                            </tr>
                        </thead>
                        <tbody id="stmt-equipment-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ุงูุชูุงุฑูุฑ (ูุน ุฃููุงุน ูุชุนุฏุฏุฉ) -->
    <div id="reports" class="page-section">
        <h3 class="mb-4">ุงูุชูุงุฑูุฑ ุงูุชูุตูููุฉ ูุงูุจุญุซ</h3>
        <div class="row mb-3 g-2">
            <div class="col-md-3"><input type="text" id="search-text" class="form-control" placeholder="ุงุจุญุซ..." onkeyup="renderReports()"></div>
            <div class="col-md-2"><input type="date" id="from-date" class="form-control" onchange="renderReports()"></div>
            <div class="col-md-2"><input type="date" id="to-date" class="form-control" onchange="renderReports()"></div>
            <div class="col-md-2">
                <select id="report-type" class="form-select" onchange="renderReports()">
                    <option value="all">ุงููู</option>
                    <option value="ูุจุถ">ูุจุถ</option>
                    <option value="ุตุฑู ุนูุฏุฉ">ุนูุฏ</option>
                    <option value="ุณุฏุงุฏ ููุฑุฏ">ุณุฏุงุฏ ููุฑุฏ</option>
                    <option value="ูุตุฑูู ูุดุฑูุน">ูุตุฑููุงุช</option>
                    <option value="ูุณุชุฎูุต">ูุณุชุฎูุตุงุช</option>
                    <option value="ุตุฑู ููุงุฏ">ุตุฑู ููุงุฏ</option>
                    <option value="ูุงุชูุฑุฉ ุดุฑุงุก">ูุดุชุฑูุงุช</option>
                    <option value="ุชุฃุฌูุฑ ูุนุฏุงุช">ุชุฃุฌูุฑ</option>
                    <option value="ุชูููุฉ ุชุดุบูู">ุชูุงููู ุชุดุบูู</option>
                    <option value="ุถุฑูุจุฉ">ุถุฑุงุฆุจ</option>
                    <option value="ุณุฏุงุฏ ูุนุฏุฉ">ุณุฏุงุฏ ูุนุฏุฉ</option>
                </select>
            </div>
            <div class="col-md-3"><button class="btn btn-secondary" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> ุชุตุฏูุฑ Excel</button></div>
        </div>
        <div class="table-res">
            <table class="table table-hover">
                <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุน</th><th>ุงูุฌูุฉ</th><th>ุงููุดุฑูุน/ุงููุฎุฒู</th><th>ุงููุจูุบ</th><th>ุงูุจูุงู</th><th>ุงูุญุงูุฉ</th><th>ุฅุฌุฑุงุกุงุช</th></tr></thead>
                <tbody id="report-body"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- ููุฏุงู ุฅุถุงูุฉ/ุชุนุฏูู ูุดุฑูุน -->
<div class="modal fade" id="projectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="projectModalTitle">ุฅุถุงูุฉ ูุดุฑูุน ุฌุฏูุฏ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="projectForm">
            <div class="row g-3">
                <div class="col-md-6"><label>ุฑูู ุงููุดุฑูุน</label><input type="text" class="form-control" id="project-code" required></div>
                <div class="col-md-6"><label>ุงุณู ุงููุดุฑูุน/ุงูุนููู</label><input type="text" class="form-control" id="project-name" required></div>
                <div class="col-md-6"><label>ุงูููุงูู (ุงูููุฑุฏ)</label><select class="form-select" id="project-contractor"><option value="">-- ุงุฎุชุฑ ุงูููุฑุฏ --</option></select></div>
                <div class="col-md-6"><label>ุชุงุฑูุฎ ุงูุจุฏุงูุฉ</label><input type="date" class="form-control" id="project-date"></div>
                <div class="col-md-6"><label>ูููุฉ ุงููุดุฑูุน (ุฌููู)</label><input type="number" class="form-control" id="project-value" min="0" step="0.01"></div>
                <div class="col-md-6"><label>ููุน ุงูุนูู</label><input type="text" class="form-control" id="project-type" placeholder="ุตูุนุงุก / ุชูุฑูุฏ ูุตูุงูุฉ"></div>
                <div class="col-md-6"><label>ุญุงูุฉ ุงููุดุฑูุน</label><select class="form-select" id="project-status"><option value="ูุดุท">ูุดุท</option><option value="ููุชูู">ููุชูู</option><option value="ูุณุชูุฑ">ูุณุชูุฑ</option></select></div>
                <div class="col-md-6"><label>ููุงุญุธุงุช</label><input type="text" class="form-control" id="project-notes"></div>
            </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
        <button type="button" class="btn btn-primary" onclick="saveProject()">ุญูุธ</button>
      </div>
    </div>
  </div>
</div>

<!-- ููุฏุงู ุชุนุฏูู ุงูุนูููุฉ -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">ุชุนุฏูู ุงูุนูููุฉ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body" id="edit-modal-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ุฅูุบุงุก</button>
        <button type="button" class="btn btn-primary" onclick="saveEdit()">ุญูุธ</button>
      </div>
    </div>
  </div>
</div>

<!-- ููุทูุฉ ููุทุจุงุนุฉ -->
<div id="print-area" class="print-only"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // ูุงุนุฏุฉ ุงูุจูุงูุงุช
    let db = JSON.parse(localStorage.getItem('final_db_enhanced_v8')) || {
        supervisors: [],
        suppliers: [],
        expenseItems: [],
        warehouses: [],
        inventoryItems: [],
        materialIssues: [],
        vouchers: [],
        expenses: [],
        invoices: [],
        projects: [],
        purchases: [],
        equipmentTypes: [],
        equipmentRentals: [],
        operationalCostTypes: [],
        taxTypes: [],
        operationalCosts: [],
        taxes: [],
        equipmentTransactions: []
    };

    // ุงูุชุฃูุฏ ูู ูุฌูุฏ ุงููุตูููุงุช ุงูุฌุฏูุฏุฉ
    db.operationalCostTypes = db.operationalCostTypes || [];
    db.taxTypes = db.taxTypes || [];
    db.operationalCosts = db.operationalCosts || [];
    db.taxes = db.taxes || [];
    db.equipmentTransactions = db.equipmentTransactions || [];

    // ุชุฑููุฉ ุงููุดุงุฑูุน ุงููุฏููุฉ
    if (db.projects.length > 0 && typeof db.projects[0] === 'string') {
        db.projects = db.projects.map(name => ({
            code: `P-${Date.now()}-${Math.floor(Math.random()*1000)}`,
            name: name,
            contractor: '',
            date: '',
            value: 0,
            type: '',
            status: 'ูุดุท',
            notes: ''
        }));
    }

    // ุชุฑููุฉ ุนูููุงุช ุงูุชุฃุฌูุฑ ุงููุฏููุฉ (ุฅุถุงูุฉ ูููุน ุฅุฐุง ูู ููู ููุฌูุฏุงู ูุชุณุฌูููุง ูู equipmentTransactions)
    db.equipmentRentals.forEach(r => {
        if (!r.location) r.location = '';
        if (!db.equipmentTransactions.some(t => t.id === r.id && t.type === 'rental')) {
            db.equipmentTransactions.push({
                id: r.id,
                date: r.date,
                equipment: r.equipmentType,
                supervisor: r.supervisor,
                project: r.project,
                location: r.location,
                hours: r.hours,
                rate: r.rate,
                amount: r.total,
                type: 'rental'
            });
        }
    });

    let currentEditId = null;
    let currentEditType = null;
    let currentProjectId = null;
    let myChart = null;
    let purchaseRows = [];
    let expenseRows = [];

    function saveToStorage() {
        localStorage.setItem('final_db_enhanced_v8', JSON.stringify(db));
    }

    // ุฏุงูุชุง ุงูุชุตุฏูุฑ ูุงูุงุณุชูุฑุงุฏ
    function exportData() {
        const dataStr = JSON.stringify(db, null, 2);
        const blob = new Blob(["\uFEFF" + dataStr], {type: "application/json;charset=utf-8;"});
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `ูุธุงู_ุงูุนุฑุจ_ููุทุงูุฉ_${new Date().toISOString().slice(0,10)}.json`;
        link.click();
    }

    document.getElementById('importFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุชุ ุณูุชู ุงุณุชุจุฏุงู ูู ุงูุจูุงูุงุช ุงูุญุงููุฉ.')) {
                    db = importedData;
                    saveToStorage();
                    refreshAll();
                    alert('ุชู ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช ุจูุฌุงุญ');
                }
            } catch (error) {
                alert('ุงูููู ุบูุฑ ุตุงูุญ');
            }
        };
        reader.readAsText(file);
    });

    function refreshAll() {
        updateSelects();
        renderSetupLists();
        renderProjectsTable();
        renderSuppliersTable();
        renderVouchersTable();
        renderExpensesTable();
        renderInvoicesTable();
        renderInventoryItems();
        renderIssuesTable();
        renderPurchasesTable();
        renderEquipmentRentalsTable();
        renderProjectCosts();
        // ุชุญุฏูุซ ูุงุฆูุฉ ุงููุดุฑููู ูู ุตูุญุฉ ูุดู ุงูุญุณุงุจ
        let stmtSup = document.getElementById('stmt-supervisor');
        if(stmtSup) stmtSup.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุดุฑู --</option>' + db.supervisors.map(s => `<option value="${s}">${s}</option>`).join('');
        // ุชุญุฏูุซ ูุงุฆูุฉ ุงููุนุฏุงุช ูู ุตูุญุฉ ูุดู ุญุณุงุจ ุงููุนุฏุฉ
        let stmtEquip = document.getElementById('stmt-equipment');
        if(stmtEquip) stmtEquip.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุนุฏุฉ --</option>' + db.equipmentTypes.map(e => `<option value="${e}">${e}</option>`).join('');

        if(document.querySelector('#dashboard.active')) renderDashboard();
        if(document.querySelector('#reports.active')) renderReports();
    }

    function updateSelects() {
        // ุงููุดุฑููู
        ['e-sup', 'issue-sup', 'eq-supervisor'].forEach(id => {
            let el = document.getElementById(id);
            if(el) el.innerHTML = '<option value="">-- ุงุฎุชุฑ --</option>' + db.supervisors.map(s => `<option value="${s}">${s}</option>`).join('');
        });
        // ุงููุดุงุฑูุน
        ['v-project', 'e-proj', 'i-proj', 'issue-proj', 'eq-project', 'pc-project', 'tax-project', 'pc-filter-project'].forEach(id => {
            let el = document.getElementById(id);
            if(el) {
                let defaultOption = id.includes('filter') ? 'ุฌููุน ุงููุดุงุฑูุน' : '-- ุงุฎุชุฑ --';
                el.innerHTML = '<option value="">' + defaultOption + '</option>' + db.projects.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            }
        });
        // ุงููุฎุงุฒู
        let whNew = document.getElementById('new-item-warehouse');
        if(whNew) whNew.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุฎุฒู</option>' + db.warehouses.map(w => `<option value="${w.id}">${w.code} - ${w.name}</option>`).join('');
        let whIssue = document.getElementById('issue-warehouse');
        if(whIssue) whIssue.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุฎุฒู</option>' + db.warehouses.map(w => `<option value="${w.id}">${w.code} - ${w.name}</option>`).join('');
        let whPurchase = document.getElementById('p-warehouse');
        if(whPurchase) whPurchase.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุฎุฒู</option>' + db.warehouses.map(w => `<option value="${w.id}">${w.code} - ${w.name}</option>`).join('');

        // ุงูููุฑุฏูู
        let contractorSelect = document.getElementById('project-contractor');
        if(contractorSelect) contractorSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูููุฑุฏ --</option>' + db.suppliers.map(s => `<option value="${s}">${s}</option>`).join('');
        let suppPurchase = document.getElementById('p-supplier');
        if(suppPurchase) suppPurchase.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูููุฑุฏ --</option>' + db.suppliers.map(s => `<option value="${s}">${s}</option>`).join('');

        // ุฃููุงุน ุงููุนุฏุงุช
        let eqTypeSelect = document.getElementById('eq-type');
        if(eqTypeSelect) eqTypeSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุนุฏุฉ --</option>' + db.equipmentTypes.map(t => `<option value="${t}">${t}</option>`).join('');

        // ุฃููุงุน ุงูุชูุงููู ุงูุชุดุบูููุฉ
        let costTypeSelect = document.getElementById('pc-cost-type');
        if(costTypeSelect) costTypeSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ --</option>' + db.operationalCostTypes.map(t => `<option value="${t}">${t}</option>`).join('');

        // ุฃููุงุน ุงูุถุฑุงุฆุจ
        let taxTypeSelect = document.getElementById('tax-type');
        if(taxTypeSelect) taxTypeSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ --</option>' + db.taxTypes.map(t => `<option value="${t}">${t}</option>`).join('');

        updateVoucherPersonSelect();
    }

    // ุชุญุฏูุซ ูุงุฆูุฉ "ุงูุฌูุฉ" ูู ุณูุฏุงุช ุงูุฎุฒููุฉ ุญุณุจ ุงูููุน
    function updateVoucherPersonSelect() {
        let type = document.getElementById('v-type').value;
        let personSelect = document.getElementById('v-person');
        if (!personSelect) return;
        if (type === 'ุณุฏุงุฏ ููุฑุฏ') {
            personSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูููุฑุฏ --</option>' + db.suppliers.map(s => `<option value="${s}">${s}</option>`).join('');
            personSelect.disabled = false;
        } else if (type === 'ุตุฑู ุนูุฏุฉ') {
            personSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุดุฑู --</option>' + db.supervisors.map(s => `<option value="${s}">${s}</option>`).join('');
            personSelect.disabled = false;
        } else if (type === 'ุณุฏุงุฏ ูุนุฏุฉ') {
            personSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงููุนุฏุฉ --</option>' + db.equipmentTypes.map(e => `<option value="${e}">${e}</option>`).join('');
            personSelect.disabled = false;
        } else {
            personSelect.innerHTML = '<option value="">-- ุบูุฑ ูุญุฏุฏ --</option>';
            personSelect.disabled = false;
        }
    }

    // ุฏุงูุฉ ุฅุถุงูุฉ ุณูุฏ (ูุนุฏูุฉ ูุชุณุฌูู ุญุฑูุงุช ุงููุนุฏุงุช)
    function addVoucher() {
        let date = document.getElementById('v-date').value || new Date().toISOString().slice(0,10);
        let type = document.getElementById('v-type').value;
        let person = document.getElementById('v-person').value;
        let project = document.getElementById('v-project').value;
        let amount = parseFloat(document.getElementById('v-amount').value);
        let desc = document.getElementById('v-desc').value.trim() || 'ุจุฏูู ุจูุงู';

        // ุงูุชุญูู ุญุณุจ ุงูููุน
        if (type === 'ุณุฏุงุฏ ููุฑุฏ' || type === 'ุตุฑู ุนูุฏุฉ' || type === 'ุณุฏุงุฏ ูุนุฏุฉ') {
            if (!person) { alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูุฌูุฉ'); return; }
        }
        if (!project) project = 'ุนุงู';
        if (isNaN(amount) || amount <= 0) { alert('ุฃุฏุฎู ูุจูุบ ุตุญูุญ ุฃูุจุฑ ูู ุตูุฑ'); return; }

        let voucher = { date, type, person, project, amount, desc, id: Date.now() };
        db.vouchers.push(voucher);

        // ุฅุฐุง ูุงู ุงูููุน ุณุฏุงุฏ ูุนุฏุฉุ ูุณุฌู ุญุฑูุฉ ุฏุงุฆูุฉ ูู equipmentTransactions
        if (type === 'ุณุฏุงุฏ ูุนุฏุฉ') {
            db.equipmentTransactions.push({
                id: voucher.id,
                date: date,
                equipment: person,
                supervisor: '',
                project: project,
                location: '',
                hours: 0,
                rate: 0,
                amount: amount,
                type: 'payment'  // ุฏุงุฆู
            });
        }

        saveToStorage();
        refreshAll();
        document.getElementById('v-date').value = '';
        document.getElementById('v-amount').value = '';
        document.getElementById('v-desc').value = '';
    }

    // ุฏุงูุฉ ุชุณุฌูู ุชุฃุฌูุฑ ูุนุฏุงุช (ูุนุฏูุฉ)
    function addEquipmentRental() {
        let date = document.getElementById('eq-date').value || new Date().toISOString().slice(0,10);
        let supervisor = document.getElementById('eq-supervisor').value;
        let equipmentType = document.getElementById('eq-type').value;
        let hours = parseFloat(document.getElementById('eq-hours').value);
        let rate = parseFloat(document.getElementById('eq-rate').value);
        let project = document.getElementById('eq-project').value || 'ุนุงู';
        let location = document.getElementById('eq-location').value.trim();
        let notes = document.getElementById('eq-notes').value.trim();

        if (!supervisor || !equipmentType) {
            alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุดุฑู ูููุน ุงููุนุฏุฉ');
            return;
        }
        if (isNaN(hours) || hours <= 0 || isNaN(rate) || rate <= 0) {
            alert('ุฃุฏุฎู ุนุฏุฏ ุณุงุนุงุช ูุณุนุฑ ุตุญูุญูู');
            return;
        }
        let total = hours * rate;

        let rental = {
            id: Date.now(),
            date: date,
            supervisor: supervisor,
            equipmentType: equipmentType,
            hours: hours,
            rate: rate,
            total: total,
            project: project,
            location: location,
            notes: notes
        };
        db.equipmentRentals.push(rental);

        // ุชุณุฌูู ุญุฑูุฉ ูุฏููุฉ ูู equipmentTransactions
        db.equipmentTransactions.push({
            id: rental.id,
            date: date,
            equipment: equipmentType,
            supervisor: supervisor,
            project: project,
            location: location,
            hours: hours,
            rate: rate,
            amount: total,
            type: 'rental'
        });

        saveToStorage();

        document.getElementById('eq-date').value = '';
        document.getElementById('eq-supervisor').value = '';
        document.getElementById('eq-type').value = '';
        document.getElementById('eq-hours').value = '';
        document.getElementById('eq-rate').value = '';
        document.getElementById('eq-project').value = '';
        document.getElementById('eq-location').value = '';
        document.getElementById('eq-notes').value = '';
        document.getElementById('eq-total').value = '';

        refreshAll();
        alert('ุชู ุชุณุฌูู ุนูููุฉ ุงูุชุฃุฌูุฑ ุจูุฌุงุญ');
    }

    // ุฏุงูุฉ ุนุฑุถ ุนูููุงุช ุงูุชุฃุฌูุฑ
    function renderEquipmentRentalsTable() {
        let tbody = document.getElementById('equipment-list');
        if (!tbody) return;
        tbody.innerHTML = db.equipmentRentals.slice().reverse().map((r, idx) => {
            let index = db.equipmentRentals.indexOf(r);
            return `<tr>
                <td>${r.date}</td>
                <td>${r.supervisor}</td>
                <td>${r.equipmentType}</td>
                <td>${r.hours}</td>
                <td>${r.rate}</td>
                <td>${r.total.toFixed(2)}</td>
                <td>${r.project}</td>
                <td>${r.location || ''}</td>
                <td>
                    <i class="fas fa-trash text-danger action-icon" onclick="deleteEquipmentRental(${index})"></i>
                    <i class="fas fa-print text-success action-icon" onclick="printEquipmentRental(${index})"></i>
                </td>
            </tr>`;
        }).join('');
    }

    // ุฏุงูุฉ ุญุฐู ุชุฃุฌูุฑ (ูุน ุญุฐู ุงูุญุฑูุฉ ุงููุฑุชุจุทุฉ)
    function deleteEquipmentRental(index) {
        if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุนูููุฉ ุงูุชุฃุฌูุฑุ')) return;
        let rental = db.equipmentRentals[index];
        // ุญุฐู ุงูุญุฑูุฉ ุงููุฑุชุจุทุฉ ูู equipmentTransactions
        db.equipmentTransactions = db.equipmentTransactions.filter(t => !(t.id === rental.id && t.type === 'rental'));
        db.equipmentRentals.splice(index, 1);
        saveToStorage();
        refreshAll();
    }

    // ุฏุงูุฉ ุทุจุงุนุฉ ุชุฃุฌูุฑ
    function printEquipmentRental(index) {
        let r = db.equipmentRentals[index];
        let printContent = `
            <div style="direction:rtl; padding:20px">
                <h2 style="text-align:center">ูุงุชูุฑุฉ ุชุฃุฌูุฑ ูุนุฏุงุช</h2>
                <hr>
                <table style="width:100%">
                    <tr><td>ุงูุชุงุฑูุฎ: ${r.date}</td><td>ุฑูู ุงูุนูููุฉ: ${r.id}</td></tr>
                    <tr><td>ุงููุดุฑู: ${r.supervisor}</td><td>ุงููุดุฑูุน: ${r.project}</td></tr>
                    <tr><td>ููุน ุงููุนุฏุฉ: ${r.equipmentType}</td><td>ุนุฏุฏ ุงูุณุงุนุงุช: ${r.hours}</td></tr>
                    <tr><td>ุณุนุฑ ุงูุณุงุนุฉ: ${r.rate} ุฌ.ู</td><td>ุงูุฅุฌูุงูู: ${r.total.toFixed(2)} ุฌ.ู</td></tr>
                    <tr><td>ูููุน ุงูุชุดุบูู: ${r.location || 'ุบูุฑ ูุญุฏุฏ'}</td><td></td></tr>
                </table>
                <p>ููุงุญุธุงุช: ${r.notes || 'ูุง ุชูุฌุฏ'}</p>
                <hr>
                <p style="text-align:left">ุงูุชูููุน: ________________</p>
            </div>`;
        let printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>ุชุฃุฌูุฑ ูุนุฏุงุช</title></head><body>' + printContent + '</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    // ุฏุงูุฉ ุญุฐู ุณูุฏ ูุนุฏุฉ (ูุน ุญุฐู ุงูุญุฑูุฉ ุงููุฑุชุจุทุฉ)
    function deleteVoucher(type, index) {
        if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐูุ')) return;
        let voucher = db.vouchers[index];
        if (type === 'ุณุฏุงุฏ ูุนุฏุฉ') {
            db.equipmentTransactions = db.equipmentTransactions.filter(t => !(t.id === voucher.id && t.type === 'payment'));
        }
        db.vouchers.splice(index, 1);
        saveToStorage();
        refreshAll();
    }

    // ุฏุงูุฉ ุฅูุดุงุก ูุดู ุญุณุงุจ ูุนุฏุฉ
    function generateEquipmentStatement() {
        let equipment = document.getElementById('stmt-equipment').value;
        let fromDate = document.getElementById('stmt-eq-from').value;
        let toDate = document.getElementById('stmt-eq-to').value;

        if (!equipment) {
            alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุนุฏุฉ');
            return;
        }
        if (!fromDate || !toDate) {
            alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ูุงูููุงูุฉ');
            return;
        }
        if (fromDate > toDate) {
            alert('ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ูุฌุจ ุฃู ูููู ูุจู ุชุงุฑูุฎ ุงูููุงูุฉ');
            return;
        }

        // ุฌูุจ ุฌููุน ุญุฑูุงุช ุงููุนุฏุฉ ูู ุงููุชุฑุฉ
        let transactions = db.equipmentTransactions.filter(t => 
            t.equipment === equipment &&
            t.date >= fromDate &&
            t.date <= toDate
        ).sort((a, b) => a.date.localeCompare(b.date));

        let totalDebit = 0, totalCredit = 0;
        let runningBalance = 0;
        let rows = transactions.map(t => {
            if (t.type === 'rental') {
                totalDebit += t.amount;
                runningBalance += t.amount;
            } else {
                totalCredit += t.amount;
                runningBalance -= t.amount;
            }
            return `<tr>
                <td>${t.date}</td>
                <td>${t.type === 'rental' ? 'ุชุฃุฌูุฑ' : 'ุณุฏุงุฏ'}</td>
                <td>${t.supervisor || ''}</td>
                <td>${t.project || ''}</td>
                <td>${t.location || ''}</td>
                <td>${t.hours || ''}</td>
                <td>${t.rate || ''}</td>
                <td>${t.amount.toFixed(2)}</td>
                <td>${runningBalance.toFixed(2)}</td>
            </tr>`;
        }).join('');

        document.getElementById('stmt-eq-name').innerText = equipment;
        document.getElementById('stmt-eq-total-debit').innerText = totalDebit.toFixed(2);
        document.getElementById('stmt-eq-total-credit').innerText = totalCredit.toFixed(2);
        document.getElementById('stmt-eq-balance').innerText = (totalDebit - totalCredit).toFixed(2);
        document.getElementById('stmt-equipment-body').innerHTML = rows;
        document.getElementById('equipment-statement-result').style.display = 'block';
    }

    function printEquipmentStatement() {
        let equipment = document.getElementById('stmt-equipment').value;
        let fromDate = document.getElementById('stmt-eq-from').value;
        let toDate = document.getElementById('stmt-eq-to').value;
        let totalDebit = document.getElementById('stmt-eq-total-debit').innerText;
        let totalCredit = document.getElementById('stmt-eq-total-credit').innerText;
        let balance = document.getElementById('stmt-eq-balance').innerText;
        let detailsRows = document.getElementById('stmt-equipment-body').innerHTML;

        let printContent = `
            <div style="direction:rtl; padding:20px">
                <h2 style="text-align:center">ูุดู ุญุณุงุจ ูุนุฏุฉ</h2>
                <hr>
                <table style="width:100%">
                    <tr><td>ุงููุนุฏุฉ: ${equipment}</td><td>ูู ุชุงุฑูุฎ: ${fromDate}</td><td>ุฅูู ุชุงุฑูุฎ: ${toDate}</td></tr>
                </table>
                <div style="margin-top:20px">
                    <div style="background:#e8f4fd; padding:10px; border-radius:5px; margin-bottom:10px">
                        <strong>ุฅุฌูุงูู ุงููุฏูู (ุชุฃุฌูุฑ):</strong> ${totalDebit} ุฌ.ู
                    </div>
                    <div style="background:#fde8e8; padding:10px; border-radius:5px; margin-bottom:10px">
                        <strong>ุฅุฌูุงูู ุงูุฏุงุฆู (ุณุฏุงุฏ):</strong> ${totalCredit} ุฌ.ู
                    </div>
                    <div style="background:#e8fde8; padding:10px; border-radius:5px; margin-bottom:10px">
                        <strong>ุงูุฑุตูุฏ:</strong> ${balance} ุฌ.ู
                    </div>
                </div>
                <h4>ุชูุงุตูู ุงูุญุฑูุงุช</h4>
                <table border="1" style="width:100%; border-collapse:collapse">
                    <thead>
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูููุน</th>
                            <th>ุงููุดุฑู</th>
                            <th>ุงููุดุฑูุน</th>
                            <th>ุงููููุน</th>
                            <th>ุงูุณุงุนุงุช</th>
                            <th>ุณุนุฑ/ุณุงุนุฉ</th>
                            <th>ุงููุจูุบ</th>
                            <th>ุงูุฑุตูุฏ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${detailsRows}
                    </tbody>
                </table>
                <hr>
                <p style="text-align:left">ุงูุชูููุน: ________________</p>
            </div>`;

        let printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>ูุดู ุญุณุงุจ ูุนุฏุฉ</title></head><body>' + printContent + '</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    // ุชุนุฏูู ุฏุงูุฉ ุนุฑุถ ุงูุณูุฏุงุช ูุชุถููู ููุน "ุณุฏุงุฏ ูุนุฏุฉ"
    function renderVouchersTable() {
        let tbody = document.getElementById('vouchers-list');
        if(!tbody) return;
        tbody.innerHTML = db.vouchers.slice(-5).reverse().map((v, idx) => `<tr>
            <td>${v.date}</td><td>${v.type}</td><td>${v.person}</td><td>${v.project}</td><td>${v.amount}</td>
            <td>
                <i class="fas fa-edit text-primary action-icon" onclick="openEdit('voucher',${db.vouchers.indexOf(v)})"></i>
                <i class="fas fa-trash text-danger action-icon" onclick="deleteVoucher('${v.type}',${db.vouchers.indexOf(v)})"></i>
                <i class="fas fa-print text-success action-icon" onclick="printTransaction('voucher',${db.vouchers.indexOf(v)})"></i>
            </td>
        </tr>`).join('');
    }

    // ุชุญุฏูุซ ุฏุงูุฉ ุงูุชูุงุฑูุฑ ูุชุดูู "ุณุฏุงุฏ ูุนุฏุฉ"
    function renderReports() {
        let search = document.getElementById('search-text').value.toLowerCase();
        let from = document.getElementById('from-date').value;
        let to = document.getElementById('to-date').value;
        let typeFilter = document.getElementById('report-type').value;
        let all = [
            ...db.vouchers.map(v => ({ ...v, _type: v.type })),
            ...db.expenses.map(e => ({ ...e, _type: e.type })),
            ...db.invoices.map(i => ({ ...i, _type: 'ูุณุชุฎูุต' })),
            ...db.materialIssues.map(m => ({ ...m, _type: 'ุตุฑู ููุงุฏ', person: m.supervisor, amount: m.total })),
            ...db.purchases.map(p => ({ ...p, _type: 'ูุงุชูุฑุฉ ุดุฑุงุก', person: p.supplier, project: `ูุฎุฒู: ${db.warehouses.find(w=>w.id==p.warehouseId)?.code}`, amount: p.totalAmount, desc: p.notes })),
            ...db.equipmentRentals.map(r => ({ ...r, _type: 'ุชุฃุฌูุฑ ูุนุฏุงุช', person: r.supervisor, project: r.project, amount: r.total, desc: r.notes })),
            ...db.operationalCosts.map(c => ({ ...c, _type: 'ุชูููุฉ ุชุดุบูู', person: '-', project: c.project, amount: c.amount, desc: c.desc })),
            ...db.taxes.map(t => ({ ...t, _type: 'ุถุฑูุจุฉ', person: '-', project: t.project, amount: t.amount, desc: t.desc }))
        ].sort((a,b)=>new Date(b.date)-new Date(a.date));
        if(typeFilter !== 'all') all = all.filter(x => x._type === typeFilter);
        if(from) all = all.filter(x => x.date >= from);
        if(to) all = all.filter(x => x.date <= to);
        if(search) all = all.filter(x => (x.person && x.person.toLowerCase().includes(search)) || (x.supervisor && x.supervisor.toLowerCase().includes(search)) || (x.project && x.project.toLowerCase().includes(search)) || (x.desc && x.desc.toLowerCase().includes(search)));
        document.getElementById('report-body').innerHTML = all.map((x, idx) => {
            let type = x._type;
            let person = x.person || x.supervisor || x.project || '-';
            let project = x.project || '-';
            let amount = x.amount || x.total || x.totalAmount || 0;
            let desc = x.desc || x.item || '';
            let status = x.paid ? (x.paid === 'ูุฏููุน' ? 'โ ูุฏููุน' : 'โ ุบูุฑ ูุฏููุน') : 'โ';
            let delFunc, editFunc, printFunc;
            if(type === 'ุตุฑู ููุงุฏ') {
                let idxIssue = db.materialIssues.findIndex(el => el.id === x.id);
                delFunc = `deleteMaterialIssue(${idxIssue})`;
                editFunc = '';
                printFunc = `printMaterialIssue(${idxIssue})`;
            } else if(type === 'ูุณุชุฎูุต') {
                let idxInv = db.invoices.findIndex(el => el.id === x.id);
                delFunc = `deleteTransaction('invoice', ${idxInv})`;
                editFunc = `openEdit('invoice', ${idxInv})`;
                printFunc = `printTransaction('invoice', ${idxInv})`;
            } else if(type === 'ูุตุฑูู ูุดุฑูุน') {
                let idxExp = db.expenses.findIndex(el => el.id === x.id);
                delFunc = `deleteTransaction('expense', ${idxExp})`;
                editFunc = `openEdit('expense', ${idxExp})`;
                printFunc = `printTransaction('expense', ${idxExp})`;
            } else if(type === 'ูุงุชูุฑุฉ ุดุฑุงุก') {
                let idxPur = db.purchases.findIndex(el => el.id === x.id);
                delFunc = `deletePurchase(${idxPur})`;
                editFunc = '';
                printFunc = `printPurchase(${idxPur})`;
            } else if(type === 'ุชุฃุฌูุฑ ูุนุฏุงุช') {
                let idxRent = db.equipmentRentals.findIndex(el => el.id === x.id);
                delFunc = `deleteEquipmentRental(${idxRent})`;
                editFunc = '';
                printFunc = `printEquipmentRental(${idxRent})`;
            } else if(type === 'ุชูููุฉ ุชุดุบูู') {
                let idxCost = db.operationalCosts.findIndex(el => el.id === x.id);
                delFunc = `deleteOperationalCost(${idxCost})`;
                editFunc = '';
                printFunc = '';
            } else if(type === 'ุถุฑูุจุฉ') {
                let idxTax = db.taxes.findIndex(el => el.id === x.id);
                delFunc = `deleteTax(${idxTax})`;
                editFunc = '';
                printFunc = '';
            } else if(type === 'ุณุฏุงุฏ ูุนุฏุฉ') {
                let idxV = db.vouchers.findIndex(el => el.id === x.id);
                delFunc = `deleteVoucher('${type}', ${idxV})`;
                editFunc = `openEdit('voucher', ${idxV})`;
                printFunc = `printTransaction('voucher', ${idxV})`;
            } else {
                let idxV = db.vouchers.findIndex(el => el.id === x.id);
                delFunc = `deleteTransaction('voucher', ${idxV})`;
                editFunc = `openEdit('voucher', ${idxV})`;
                printFunc = `printTransaction('voucher', ${idxV})`;
            }
            return `<tr><td>${x.date}</td><td>${type}</td><td>${person}</td><td>${project}</td><td>${amount} ุฌ.ู</td><td>${desc}</td><td>${status}</td><td>
                ${editFunc ? `<i class="fas fa-edit text-primary action-icon" onclick="${editFunc}"></i>` : ''}
                <i class="fas fa-trash text-danger action-icon" onclick="${delFunc}"></i>
                ${printFunc ? `<i class="fas fa-print text-success action-icon" onclick="${printFunc}"></i>` : ''}
            </td></tr>`;
        }).join('');
    }

    // ==================== ุฏูุงู ุงูุฅุนุฏุงุฏุงุช ====================
    function renderSetupLists() {
        document.getElementById('sup-list').innerHTML = db.supervisors.map((s,i) => `<div class="d-flex justify-content-between"><span>${s}</span> <i class="fas fa-trash text-danger action-icon" onclick="deleteItem('supervisors',${i})"></i></div>`).join('');
        document.getElementById('supp-list').innerHTML = db.suppliers.map((s,i) => `<div class="d-flex justify-content-between"><span>${s}</span> <i class="fas fa-trash text-danger action-icon" onclick="deleteItem('suppliers',${i})"></i></div>`).join('');
        document.getElementById('item-list').innerHTML = db.expenseItems.map((s,i) => `<div class="d-flex justify-content-between"><span>${s}</span> <i class="fas fa-trash text-danger action-icon" onclick="deleteItem('expenseItems',${i})"></i></div>`).join('');
        let whList = document.getElementById('warehouse-list');
        if(whList) whList.innerHTML = db.warehouses.map((w,i) => `<div class="d-flex justify-content-between"><span>${w.code} - ${w.name}</span> <i class="fas fa-trash text-danger action-icon" onclick="deleteWarehouse(${i})"></i></div>`).join('');
        let equipList = document.getElementById('equip-list');
        if(equipList) equipList.innerHTML = db.equipmentTypes.map((t,i) => `<div class="d-flex justify-content-between"><span>${t}</span> <i class="fas fa-trash text-danger action-icon" onclick="deleteItem('equipmentTypes',${i})"></i></div>`).join('');
        let opCostList = document.getElementById('op-cost-list');
        if(opCostList) opCostList.innerHTML = db.operationalCostTypes.map((t,i) => `<div class="d-flex justify-content-between"><span>${t}</span> <i class="fas fa-trash text-danger action-icon" onclick="deleteItem('operationalCostTypes',${i})"></i></div>`).join('');
        let taxList = document.getElementById('tax-list');
        if(taxList) taxList.innerHTML = db.taxTypes.map((t,i) => `<div class="d-flex justify-content-between"><span>${t}</span> <i class="fas fa-trash text-danger action-icon" onclick="deleteItem('taxTypes',${i})"></i></div>`).join('');
    }

    function deleteItem(key, index) {
        if(!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐูุ')) return;
        db[key].splice(index, 1);
        saveToStorage();
        refreshAll();
    }

    function addItem(key, inputId) {
        let val = document.getElementById(inputId).value.trim();
        if(!val) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ูููุฉ'); return; }
        db[key].push(val);
        saveToStorage();
        document.getElementById(inputId).value = '';
        refreshAll();
    }

    function addWarehouse() {
        let code = document.getElementById('s-wh-code').value.trim();
        let name = document.getElementById('s-wh-name').value.trim();
        if(!code || !name) { alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ููุฏ ูุงุณู ุงููุฎุฒู'); return; }
        db.warehouses.push({ id: Date.now(), code, name });
        saveToStorage();
        document.getElementById('s-wh-code').value = '';
        document.getElementById('s-wh-name').value = '';
        refreshAll();
    }

    function deleteWarehouse(index) {
        if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุฎุฒูุ')) {
            db.warehouses.splice(index, 1);
            saveToStorage();
            refreshAll();
        }
    }

    // ==================== ุฏูุงู ุงููุดุงุฑูุน ====================
    function renderProjectsTable() {
        let tbody = document.getElementById('projects-table-body');
        if(!tbody) return;
        const today = new Date().toISOString().split('T')[0];

        tbody.innerHTML = db.projects.map((p, index) => {
            let autoStatus = p.status;
            if (p.date) {
                if (p.date < today) autoStatus = 'ููุชูู';
                else autoStatus = 'ูุณุชูุฑ';
            }
            return `<tr>
                <td>${p.code || ''}</td>
                <td>${p.name || ''}</td>
                <td>${p.contractor || ''}</td>
                <td>${p.date || ''}</td>
                <td>${p.value ? p.value.toLocaleString() : '0'}</td>
                <td>${p.type || ''}</td>
                <td>${autoStatus}</td>
                <td>${p.notes || ''}</td>
                <td>
                    <i class="fas fa-edit text-primary action-icon" onclick="openProjectModal(${index})"></i>
                    <i class="fas fa-trash text-danger action-icon" onclick="deleteProject(${index})"></i>
                </td>
            </tr>`;
        }).join('');
    }

    function openProjectModal(index = null) {
        currentProjectId = index;
        document.getElementById('projectModalTitle').innerText = index === null ? 'ุฅุถุงูุฉ ูุดุฑูุน ุฌุฏูุฏ' : 'ุชุนุฏูู ุงููุดุฑูุน';
        let contractorSelect = document.getElementById('project-contractor');
        contractorSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูููุฑุฏ --</option>' + db.suppliers.map(s => `<option value="${s}">${s}</option>`).join('');

        if (index !== null) {
            let p = db.projects[index];
            document.getElementById('project-code').value = p.code || '';
            document.getElementById('project-name').value = p.name || '';
            document.getElementById('project-contractor').value = p.contractor || '';
            document.getElementById('project-date').value = p.date || '';
            document.getElementById('project-value').value = p.value || 0;
            document.getElementById('project-type').value = p.type || '';
            document.getElementById('project-status').value = p.status || 'ูุดุท';
            document.getElementById('project-notes').value = p.notes || '';
        } else {
            document.getElementById('project-code').value = '';
            document.getElementById('project-name').value = '';
            document.getElementById('project-contractor').value = '';
            document.getElementById('project-date').value = '';
            document.getElementById('project-value').value = '';
            document.getElementById('project-type').value = '';
            document.getElementById('project-status').value = 'ูุดุท';
            document.getElementById('project-notes').value = '';
        }
        new bootstrap.Modal(document.getElementById('projectModal')).show();
    }

    function saveProject() {
        let code = document.getElementById('project-code').value.trim();
        let name = document.getElementById('project-name').value.trim();
        if(!code || !name) { alert('ุฑูู ุงููุดุฑูุน ูุงุณู ุงููุดุฑูุน ูุทููุจุงู'); return; }
        let project = {
            code: code,
            name: name,
            contractor: document.getElementById('project-contractor').value.trim(),
            date: document.getElementById('project-date').value,
            value: parseFloat(document.getElementById('project-value').value) || 0,
            type: document.getElementById('project-type').value.trim(),
            status: document.getElementById('project-status').value,
            notes: document.getElementById('project-notes').value.trim()
        };
        if (currentProjectId === null) {
            db.projects.push(project);
        } else {
            db.projects[currentProjectId] = project;
        }
        saveToStorage();
        bootstrap.Modal.getInstance(document.getElementById('projectModal')).hide();
        refreshAll();
    }

    function deleteProject(index) {
        if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุดุฑูุนุ')) {
            db.projects.splice(index, 1);
            saveToStorage();
            refreshAll();
        }
    }

    // ==================== ุตูุญุฉ ุงูููุฑุฏูู ====================
    function renderSuppliersTable() {
        let tbody = document.getElementById('suppliers-table-body');
        if(!tbody) return;

        let html = '';
        db.suppliers.forEach((supplier, index) => {
            let totalPurchases = 0;
            db.invoices.forEach(inv => {
                let project = db.projects.find(p => p.name === inv.project);
                if (project && project.contractor === supplier) {
                    totalPurchases += inv.net;
                }
            });
            db.purchases.forEach(p => {
                if (p.supplier === supplier) {
                    totalPurchases += p.totalAmount;
                }
            });

            let totalPaid = db.vouchers.filter(v => v.type === 'ุณุฏุงุฏ ููุฑุฏ' && v.person === supplier)
                                        .reduce((sum, v) => sum + v.amount, 0);
            let balance = totalPurchases - totalPaid;
            html += `<tr>
                <td>${supplier}</td>
                <td>${totalPurchases.toFixed(2)}</td>
                <td>${totalPaid.toFixed(2)}</td>
                <td class="${balance >= 0 ? 'text-success' : 'text-danger'}">${balance.toFixed(2)}</td>
                <td>
                    <i class="fas fa-trash text-danger action-icon" onclick="deleteSupplierFromPage(${index})"></i>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    function addSupplierFromPage() {
        let name = prompt('ุฃุฏุฎู ุงุณู ุงูููุฑุฏ ุงูุฌุฏูุฏ:');
        if (name && name.trim()) {
            db.suppliers.push(name.trim());
            saveToStorage();
            refreshAll();
        }
    }

    function deleteSupplierFromPage(index) {
        if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูููุฑุฏุ')) {
            db.suppliers.splice(index, 1);
            saveToStorage();
            refreshAll();
        }
    }

    // ==================== ุฏูุงู ุงููุดุชุฑูุงุช ====================
    function initPurchaseRows() {
        purchaseRows = [{ itemId: '', itemCode: '', itemName: '', unit: '', quantity: 1, price: 0, total: 0 }];
        renderPurchaseRows();
    }

    function addPurchaseRow() {
        purchaseRows.push({ itemId: '', itemCode: '', itemName: '', unit: '', quantity: 1, price: 0, total: 0 });
        renderPurchaseRows();
    }

    function removePurchaseRow(index) {
        purchaseRows.splice(index, 1);
        renderPurchaseRows();
        calculatePurchaseTotal();
    }

    function renderPurchaseRows() {
        let container = document.getElementById('purchase-items-container');
        if(!container) return;
        let warehouseId = document.getElementById('p-warehouse').value;
        let itemsInWarehouse = warehouseId ? db.inventoryItems.filter(i => i.warehouseId == warehouseId) : [];

        let html = '';
        purchaseRows.forEach((row, idx) => {
            html += `<tr>
                <td>
                    <select class="form-select purchase-item" data-index="${idx}" onchange="updatePurchaseRow(${idx}, 'itemId', this.value)">
                        <option value="">-- ุงุฎุชุฑ ุงูุตูู --</option>
                        ${itemsInWarehouse.map(it => `<option value="${it.id}" data-code="${it.code}" data-name="${it.name}" data-unit="${it.unit}" ${it.id == row.itemId ? 'selected' : ''}>${it.code} - ${it.name} (${it.unit})</option>`).join('')}
                    </select>
                </td>
                <td><input type="text" class="form-control" value="${row.unit}" readonly></td>
                <td><input type="number" class="form-control purchase-qty" data-index="${idx}" value="${row.quantity}" min="1" step="1" oninput="updatePurchaseRow(${idx}, 'quantity', this.value)"></td>
                <td><input type="number" class="form-control purchase-price" data-index="${idx}" value="${row.price}" min="0" step="0.01" oninput="updatePurchaseRow(${idx}, 'price', this.value)"></td>
                <td><input type="number" class="form-control" value="${row.total.toFixed(2)}" readonly></td>
                <td><button class="btn btn-sm btn-danger" onclick="removePurchaseRow(${idx})"><i class="fas fa-times"></i></button></td>
            </tr>`;
        });
        container.innerHTML = html;
        document.querySelectorAll('.purchase-item').forEach(select => {
            select.addEventListener('change', function(e) {
                let idx = this.getAttribute('data-index');
                let selectedOption = this.options[this.selectedIndex];
                let unit = selectedOption.getAttribute('data-unit') || '';
                let row = purchaseRows[idx];
                row.unit = unit;
                let unitInput = this.closest('tr').querySelector('td:nth-child(2) input');
                if(unitInput) unitInput.value = unit;
                calculatePurchaseTotal();
            });
        });
        calculatePurchaseTotal();
    }

    function updatePurchaseRow(index, field, value) {
        let row = purchaseRows[index];
        if (field === 'itemId') {
            let select = document.querySelector(`.purchase-item[data-index="${index}"]`);
            let selectedOption = select.options[select.selectedIndex];
            row.itemId = value;
            row.itemCode = selectedOption.getAttribute('data-code') || '';
            row.itemName = selectedOption.getAttribute('data-name') || '';
            row.unit = selectedOption.getAttribute('data-unit') || '';
            let unitInput = select.closest('tr').querySelector('td:nth-child(2) input');
            if(unitInput) unitInput.value = row.unit;
        } else if (field === 'quantity') {
            row.quantity = parseInt(value) || 0;
        } else if (field === 'price') {
            row.price = parseFloat(value) || 0;
        }
        row.total = row.quantity * row.price;
        let rowElement = document.querySelector(`.purchase-item[data-index="${index}"]`).closest('tr');
        let totalInput = rowElement.querySelector('td:nth-child(5) input');
        if(totalInput) totalInput.value = row.total.toFixed(2);
        calculatePurchaseTotal();
    }

    function calculatePurchaseTotal() {
        let total = purchaseRows.reduce((sum, row) => sum + (row.total || 0), 0);
        document.getElementById('purchase-total').value = total.toFixed(2);
    }

    function loadPurchaseItems() {
        renderPurchaseRows();
    }

    function addPurchaseInvoice() {
        let date = document.getElementById('p-date').value || new Date().toISOString().slice(0,10);
        let supplier = document.getElementById('p-supplier').value;
        let warehouseId = document.getElementById('p-warehouse').value;
        let invNo = document.getElementById('p-inv-no').value.trim();
        let fileUrl = document.getElementById('p-file-url').value.trim();
        let notes = document.getElementById('p-notes').value.trim();

        if (!supplier || !warehouseId) {
            alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงูููุฑุฏ ูุงููุฎุฒู');
            return;
        }
        if (purchaseRows.length === 0 || purchaseRows.every(r => !r.itemId)) {
            alert('ุฃุถู ุตููุงู ูุงุญุฏุงู ุนูู ุงูุฃูู');
            return;
        }
        for (let row of purchaseRows) {
            if (!row.itemId || row.quantity <= 0 || row.price <= 0) {
                alert('ุชุฃูุฏ ูู ุฅุฏุฎุงู ุงูุจูุงูุงุช ุจุดูู ุตุญูุญ ูู ุฌููุน ุงูุฃุตูุงู');
                return;
            }
        }

        let totalAmount = purchaseRows.reduce((sum, row) => sum + row.total, 0);

        let purchase = {
            id: Date.now(),
            date: date,
            supplier: supplier,
            warehouseId: parseInt(warehouseId),
            invoiceNumber: invNo,
            fileUrl: fileUrl,
            notes: notes,
            items: purchaseRows.map(row => ({
                itemId: row.itemId,
                itemCode: row.itemCode,
                itemName: row.itemName,
                unit: row.unit,
                quantity: row.quantity,
                price: row.price,
                total: row.total
            })),
            totalAmount: totalAmount
        };

        purchase.items.forEach(item => {
            let inventoryItem = db.inventoryItems.find(i => i.id == item.itemId);
            if (inventoryItem) {
                inventoryItem.quantity += item.quantity;
            } else {
                alert('ุงูุตูู ุบูุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช');
                return;
            }
        });

        db.purchases.push(purchase);
        saveToStorage();

        document.getElementById('p-date').value = '';
        document.getElementById('p-supplier').value = '';
        document.getElementById('p-warehouse').value = '';
        document.getElementById('p-inv-no').value = '';
        document.getElementById('p-file-url').value = '';
        document.getElementById('p-notes').value = '';
        initPurchaseRows();

        refreshAll();
        alert('ุชู ุชุณุฌูู ูุงุชูุฑุฉ ุงูุดุฑุงุก ุจูุฌุงุญ');
    }

    function renderPurchasesTable() {
        let tbody = document.getElementById('purchases-list');
        if (!tbody) return;
        tbody.innerHTML = db.purchases.slice().reverse().map((p, idx) => {
            let warehouse = db.warehouses.find(w => w.id == p.warehouseId);
            let whName = warehouse ? `${warehouse.code} - ${warehouse.name}` : 'ุบูุฑ ูุญุฏุฏ';
            let fileLink = p.fileUrl ? `<a href="${p.fileUrl}" target="_blank" title="ุชุญููู ุงููุงุชูุฑุฉ"><i class="fas fa-download"></i></a>` : 'โ';
            return `<tr>
                <td>${p.date}</td>
                <td>${p.supplier}</td>
                <td>${whName}</td>
                <td>${p.invoiceNumber || 'โ'}</td>
                <td>${p.totalAmount.toFixed(2)}</td>
                <td>${fileLink}</td>
                <td>
                    <i class="fas fa-trash text-danger action-icon" onclick="deletePurchase(${db.purchases.indexOf(p)})"></i>
                    <i class="fas fa-print text-success action-icon" onclick="printPurchase(${db.purchases.indexOf(p)})"></i>
                </td>
            </tr>`;
        }).join('');
    }

    function deletePurchase(index) {
        if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุงุชูุฑุฉ ุงูุดุฑุงุกุ ุณูุชู ุฎุตู ุงููููุงุช ูู ุงููุฎุฒูู.')) return;
        let purchase = db.purchases[index];
        purchase.items.forEach(item => {
            let inventoryItem = db.inventoryItems.find(i => i.id == item.itemId);
            if (inventoryItem) {
                inventoryItem.quantity -= item.quantity;
                if (inventoryItem.quantity < 0) inventoryItem.quantity = 0;
            }
        });
        db.purchases.splice(index, 1);
        saveToStorage();
        refreshAll();
    }

    function printPurchase(index) {
        let p = db.purchases[index];
        let warehouse = db.warehouses.find(w => w.id == p.warehouseId);
        let whName = warehouse ? `${warehouse.code} - ${warehouse.name}` : 'ุบูุฑ ูุญุฏุฏ';
        let itemsHtml = p.items.map(item => `<tr><td>${item.itemCode}</td><td>${item.itemName}</td><td>${item.unit}</td><td>${item.quantity}</td><td>${item.price}</td><td>${item.total}</td></tr>`).join('');
        let printContent = `
            <div style="direction:rtl; padding:20px">
                <h2 style="text-align:center">ูุงุชูุฑุฉ ุดุฑุงุก</h2>
                <hr>
                <table style="width:100%">
                    <tr><td>ุงูุชุงุฑูุฎ: ${p.date}</td><td>ุฑูู ุงููุงุชูุฑุฉ: ${p.invoiceNumber || 'โ'}</td></tr>
                    <tr><td>ุงูููุฑุฏ: ${p.supplier}</td><td>ุงููุฎุฒู: ${whName}</td></tr>
                </table>
                <table border="1" style="width:100%; border-collapse:collapse; margin-top:20px">
                    <thead><tr><th>ููุฏ ุงูุตูู</th><th>ุงุณู ุงูุตูู</th><th>ุงููุญุฏุฉ</th><th>ุงููููุฉ</th><th>ุณุนุฑ ุงูุดุฑุงุก</th><th>ุงูุฅุฌูุงูู</th></tr></thead>
                    <tbody>${itemsHtml}</tbody>
                </table>
                <p><strong>ุงูุฅุฌูุงูู ุงูููู: ${p.totalAmount} ุฌ.ู</strong></p>
                <p>ููุงุญุธุงุช: ${p.notes || ''}</p>
                ${p.fileUrl ? `<p>ุฑุงุจุท ุงููุงุชูุฑุฉ: <a href="${p.fileUrl}" target="_blank">${p.fileUrl}</a></p>` : ''}
                <hr>
                <p style="text-align:left">ุงูุชูููุน: ________________</p>
            </div>`;
        let printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>ูุงุชูุฑุฉ ุดุฑุงุก</title></head><body>' + printContent + '</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    // ==================== ุฏูุงู ุงููุตุฑููุงุช ====================
    function initExpenseRows() {
        expenseRows = [{ item: '', amount: '', desc: '' }];
        renderExpenseRows();
    }

    function addExpenseRow() {
        expenseRows.push({ item: '', amount: '', desc: '' });
        renderExpenseRows();
    }

    function removeExpenseRow(index) {
        expenseRows.splice(index, 1);
        renderExpenseRows();
    }

    function renderExpenseRows() {
        let container = document.getElementById('expense-items-container');
        if(!container) return;
        let html = '';
        expenseRows.forEach((row, idx) => {
            html += `<tr>
                <td>
                    <select class="form-select expense-item" data-index="${idx}" onchange="updateExpenseRow(${idx}, 'item', this.value)">
                        <option value="">-- ุงุฎุชุฑ --</option>
                        ${db.expenseItems.map(it => `<option value="${it}" ${row.item === it ? 'selected' : ''}>${it}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" class="form-control expense-amount" data-index="${idx}" value="${row.amount}" min="0" step="0.01" oninput="updateExpenseRow(${idx}, 'amount', this.value)">
                </td>
                <td>
                    <input type="text" class="form-control expense-desc" data-index="${idx}" value="${row.desc}" placeholder="ุงุฎุชูุงุฑู" oninput="updateExpenseRow(${idx}, 'desc', this.value)">
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removeExpenseRow(${idx})"><i class="fas fa-times"></i></button>
                </td>
            </tr>`;
        });
        container.innerHTML = html;
        calculateExpenseTotal();
    }

    function updateExpenseRow(index, field, value) {
        expenseRows[index][field] = value;
        if(field === 'amount') calculateExpenseTotal();
    }

    function calculateExpenseTotal() {
        let total = expenseRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
        document.getElementById('expense-total').value = total.toFixed(2);
    }

    function updateSupervisorBalance() {
        let sup = document.getElementById('e-sup').value;
        if(!sup) {
            document.getElementById('supervisor-balance').innerHTML = 'ุงูุนูุฏุฉ ุงูุญุงููุฉ: 0 ุฌ.ู';
            return;
        }
        let totalReceived = db.vouchers.filter(v => v.type === 'ุตุฑู ุนูุฏุฉ' && v.person === sup).reduce((s, v) => s + v.amount, 0);
        let totalSpent = db.expenses.filter(e => e.person === sup).reduce((s, e) => s + e.amount, 0);
        let balance = totalReceived - totalSpent;
        document.getElementById('supervisor-balance').innerHTML = `ุงูุนูุฏุฉ ุงูุญุงููุฉ: ${balance.toLocaleString()} ุฌ.ู`;
    }

    function addExpense() {
        let date = document.getElementById('e-date').value || new Date().toISOString().slice(0,10);
        let supervisor = document.getElementById('e-sup').value;
        let project = document.getElementById('e-proj').value;
        if(!supervisor || !project) { alert('ุงุฎุชุฑ ุงููุดุฑู ูุงููุดุฑูุน'); return; }
        if(expenseRows.length === 0 || expenseRows.every(r => !r.item || !r.amount)) {
            alert('ุฃุถู ุจููุฏ ุตุญูุญุฉ');
            return;
        }
        let total = expenseRows.reduce((s, r) => s + (parseFloat(r.amount) || 0), 0);
        let totalReceived = db.vouchers.filter(v => v.type === 'ุตุฑู ุนูุฏุฉ' && v.person === supervisor).reduce((s, v) => s + v.amount, 0);
        let totalSpent = db.expenses.filter(e => e.person === supervisor).reduce((s, e) => s + e.amount, 0);
        let balance = totalReceived - totalSpent;
        if(total > balance) {
            if(!confirm('ุฑุตูุฏ ุงูุนูุฏุฉ ุบูุฑ ูุงูู. ูู ุชุฑูุฏ ุงููุชุงุจุนุฉุ')) return;
        }
        expenseRows.forEach(row => {
            if(row.item && row.amount) {
                let expense = {
                    date, type: 'ูุตุฑูู ูุดุฑูุน',
                    person: supervisor,
                    project: project,
                    item: row.item,
                    amount: parseFloat(row.amount),
                    desc: row.desc || row.item,
                    id: Date.now() + Math.random()
                };
                db.expenses.push(expense);
            }
        });
        saveToStorage();
        document.getElementById('e-date').value = '';
        document.getElementById('e-sup').value = '';
        document.getElementById('e-proj').value = '';
        initExpenseRows();
        refreshAll();
        alert('ุชู ุชุณุฌูู ุงููุตุฑููุงุช ุจูุฌุงุญ');
    }

    // ==================== ุฏูุงู ุงูุณูุฏุงุช ูุงููุณุชุฎูุตุงุช ====================
    function renderExpensesTable() {
        let tbody = document.getElementById('expenses-list');
        if(!tbody) return;
        tbody.innerHTML = db.expenses.slice(-5).reverse().map((e, idx) => `<tr>
            <td>${e.date}</td><td>${e.person}</td><td>${e.project}</td><td>${e.item}</td><td>${e.amount}</td>
            <td>
                <i class="fas fa-edit text-primary action-icon" onclick="openEdit('expense',${db.expenses.indexOf(e)})"></i>
                <i class="fas fa-trash text-danger action-icon" onclick="deleteTransaction('expense',${db.expenses.indexOf(e)})"></i>
                <i class="fas fa-print text-success action-icon" onclick="printTransaction('expense',${db.expenses.indexOf(e)})"></i>
            </td>
        </tr>`).join('');
    }

    function renderInvoicesTable() {
        let tbody = document.getElementById('invoices-list');
        if(!tbody) return;
        tbody.innerHTML = db.invoices.slice(-5).reverse().map((inv, idx) => `<tr>
            <td>${inv.date}</td><td>${inv.project}</td><td>${inv.invNo}</td><td>${inv.net}</td>
            <td>${inv.paid || 'ุบูุฑ ูุฏููุน'}</td>
            <td>
                <i class="fas fa-edit text-primary action-icon" onclick="openEdit('invoice',${db.invoices.indexOf(inv)})"></i>
                <i class="fas fa-trash text-danger action-icon" onclick="deleteTransaction('invoice',${db.invoices.indexOf(inv)})"></i>
                <i class="fas fa-print text-success action-icon" onclick="printTransaction('invoice',${db.invoices.indexOf(inv)})"></i>
            </td>
        </tr>`).join('');
    }

    function addInvoice() {
        let date = document.getElementById('i-date').value || new Date().toISOString().slice(0,10);
        let project = document.getElementById('i-proj').value;
        let invNo = document.getElementById('i-no').value.trim();
        let val = parseFloat(document.getElementById('i-val').value) || 0;
        let tamin = parseFloat(document.getElementById('i-tamin').value) || 0;
        let tax = parseFloat(document.getElementById('i-tax').value) || 0;
        let paid = document.getElementById('i-paid').value;
        if(!project || !invNo) { alert('ุฃููู ุงูุจูุงูุงุช'); return; }
        if(val <=0) { alert('ูููุฉ ุงูุฃุนูุงู ูุฌุจ ุฃู ุชููู ุฃูุจุฑ ูู ุตูุฑ'); return; }
        let net = val - tamin - tax;
        document.getElementById('i-net').value = net;
        let invoice = { date, type: 'ูุณุชุฎูุต', project, invNo, amount: val, tamin, tax, net, paid, desc: `ูุณุชุฎูุต ${invNo}`, id: Date.now() };
        db.invoices.push(invoice);
        saveToStorage();
        refreshAll();
        document.getElementById('i-date').value = '';
        document.getElementById('i-no').value = '';
        document.getElementById('i-val').value = '';
        document.getElementById('i-tamin').value = '';
        document.getElementById('i-tax').value = '';
        document.getElementById('i-net').value = '';
    }

    function deleteTransaction(type, index) {
        if(!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงูุญุฐูุ')) return;
        if(type === 'voucher') db.vouchers.splice(index,1);
        else if(type === 'expense') db.expenses.splice(index,1);
        else if(type === 'invoice') db.invoices.splice(index,1);
        saveToStorage();
        refreshAll();
    }

    function openEdit(type, index) {
        currentEditType = type;
        currentEditId = index;
        let item;
        if(type === 'voucher') item = db.vouchers[index];
        else if(type === 'expense') item = db.expenses[index];
        else if(type === 'invoice') item = db.invoices[index];
        else return;
        let body = document.getElementById('edit-modal-body');
        if(type === 'voucher') {
            body.innerHTML = `
                <label>ุงูุชุงุฑูุฎ</label><input type="date" id="edit-date" class="form-control" value="${item.date}">
                <label class="mt-2">ุงูููุน</label><select id="edit-type" class="form-select">${['ูุจุถ','ุตุฑู ุนูุฏุฉ','ุณุฏุงุฏ ููุฑุฏ'].map(t => `<option ${t===item.type?'selected':''}>${t}</option>`).join('')}</select>
                <label class="mt-2">ุงูุฌูุฉ</label>
                <select id="edit-person" class="form-select">${db.supervisors.map(s => `<option ${s===item.person?'selected':''}>${s}</option>`).join('')}</select>
                <label class="mt-2">ุงููุดุฑูุน</label>
                <select id="edit-project" class="form-select">${db.projects.map(p => `<option ${p.name===item.project?'selected':''}>${p.name}</option>`).join('')}</select>
                <label class="mt-2">ุงููุจูุบ</label><input type="number" id="edit-amount" class="form-control" value="${item.amount}">
                <label class="mt-2">ุงูุจูุงู</label><input class="form-control" id="edit-desc" value="${item.desc}">
            `;
        } else if(type === 'expense') {
            body.innerHTML = `
                <label>ุงูุชุงุฑูุฎ</label><input type="date" id="edit-date" class="form-control" value="${item.date}">
                <label class="mt-2">ุงููุดุฑู</label><input class="form-control" id="edit-person" value="${item.person}">
                <label class="mt-2">ุงููุดุฑูุน</label><input class="form-control" id="edit-project" value="${item.project}">
                <label class="mt-2">ุงูุจูุฏ</label><input class="form-control" id="edit-item" value="${item.item}">
                <label class="mt-2">ุงููุจูุบ</label><input type="number" id="edit-amount" class="form-control" value="${item.amount}">
                <label class="mt-2">ุงูุจูุงู</label><input class="form-control" id="edit-desc" value="${item.desc}">
            `;
        } else if(type === 'invoice') {
            body.innerHTML = `
                <label>ุงูุชุงุฑูุฎ</label><input type="date" id="edit-date" class="form-control" value="${item.date}">
                <label class="mt-2">ุงููุดุฑูุน</label><input class="form-control" id="edit-project" value="${item.project}">
                <label class="mt-2">ุฑูู ุงููุณุชุฎูุต</label><input class="form-control" id="edit-invNo" value="${item.invNo}">
                <label class="mt-2">ุงููููุฉ</label><input type="number" id="edit-amount" class="form-control" value="${item.amount}">
                <label class="mt-2">ุชุฃููู</label><input type="number" id="edit-tamin" class="form-control" value="${item.tamin || 0}">
                <label class="mt-2">ุถุฑุงุฆุจ</label><input type="number" id="edit-tax" class="form-control" value="${item.tax || 0}">
                <label class="mt-2">ุงูุตุงูู</label><input type="number" id="edit-net" class="form-control" value="${item.net}" readonly>
                <label class="mt-2">ุญุงูุฉ ุงูุฏูุน</label>
                <select id="edit-paid" class="form-select">
                    <option value="ุบูุฑ ูุฏููุน" ${item.paid === 'ุบูุฑ ูุฏููุน' ? 'selected' : ''}>โ ุบูุฑ ูุฏููุน</option>
                    <option value="ูุฏููุน" ${item.paid === 'ูุฏููุน' ? 'selected' : ''}>โ ูุฏููุน</option>
                </select>
            `;
        }
        new bootstrap.Modal(document.getElementById('editModal')).show();
    }

    function saveEdit() {
        let date = document.getElementById('edit-date').value;
        if(currentEditType === 'voucher') {
            let item = db.vouchers[currentEditId];
            item.date = date;
            item.type = document.getElementById('edit-type').value;
            item.person = document.getElementById('edit-person').value;
            item.project = document.getElementById('edit-project').value;
            item.amount = parseFloat(document.getElementById('edit-amount').value);
            item.desc = document.getElementById('edit-desc').value;
        } else if(currentEditType === 'expense') {
            let item = db.expenses[currentEditId];
            item.date = date;
            item.person = document.getElementById('edit-person').value;
            item.project = document.getElementById('edit-project').value;
            item.item = document.getElementById('edit-item').value;
            item.amount = parseFloat(document.getElementById('edit-amount').value);
            item.desc = document.getElementById('edit-desc').value;
        } else if(currentEditType === 'invoice') {
            let item = db.invoices[currentEditId];
            item.date = date;
            item.project = document.getElementById('edit-project').value;
            item.invNo = document.getElementById('edit-invNo').value;
            item.amount = parseFloat(document.getElementById('edit-amount').value);
            item.tamin = parseFloat(document.getElementById('edit-tamin').value);
            item.tax = parseFloat(document.getElementById('edit-tax').value);
            item.net = item.amount - item.tamin - item.tax;
            item.paid = document.getElementById('edit-paid').value;
        }
        saveToStorage();
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        refreshAll();
    }

    // ==================== ุฏูุงู ุงููุฎุฒูู ====================
    function addInventoryItem() {
        let code = document.getElementById('new-item-code').value.trim();
        let name = document.getElementById('new-item-name').value.trim();
        let unit = document.getElementById('new-item-unit').value.trim();
        let price = parseFloat(document.getElementById('new-item-price').value);
        let qty = parseInt(document.getElementById('new-item-qty').value);
        let warehouseId = document.getElementById('new-item-warehouse').value;
        if(!code || !name || !unit || isNaN(price) || price<0 || isNaN(qty) || qty<0 || !warehouseId) {
            alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฌููุน ุงูุจูุงูุงุช'); return;
        }
        let newItem = { id: Date.now(), code, name, unit, price, quantity: qty, warehouseId: parseInt(warehouseId) };
        db.inventoryItems.push(newItem);
        saveToStorage();
        document.getElementById('new-item-code').value = '';
        document.getElementById('new-item-name').value = '';
        document.getElementById('new-item-unit').value = '';
        document.getElementById('new-item-price').value = '';
        document.getElementById('new-item-qty').value = '';
        refreshAll();
    }

    function deleteInventoryItem(id) {
        if(confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุตููุ')) {
            db.inventoryItems = db.inventoryItems.filter(item => item.id !== id);
            saveToStorage();
            refreshAll();
        }
    }

    function renderInventoryItems() {
        let tbody = document.getElementById('inventory-items-list');
        if(!tbody) return;
        tbody.innerHTML = db.inventoryItems.map(item => {
            let warehouse = db.warehouses.find(w => w.id === item.warehouseId);
            let whName = warehouse ? `${warehouse.code} - ${warehouse.name}` : 'ุบูุฑ ูุญุฏุฏ';
            return `<tr><td>${item.code}</td><td>${item.name}</td><td>${item.unit}</td><td>${item.price}</td><td>${item.quantity}</td><td>${whName}</td><td><i class="fas fa-trash text-danger action-icon" onclick="deleteInventoryItem(${item.id})"></i></td></tr>`;
        }).join('');
    }

    function loadItemsForWarehouse() {
        let warehouseId = document.getElementById('issue-warehouse').value;
        let itemSelect = document.getElementById('issue-item');
        if(!warehouseId) { itemSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูุตูู --</option>'; return; }
        let items = db.inventoryItems.filter(i => i.warehouseId == warehouseId && i.quantity > 0);
        itemSelect.innerHTML = '<option value="">-- ุงุฎุชุฑ ุงูุตูู --</option>' + items.map(i => `<option value="${i.id}" data-price="${i.price}" data-unit="${i.unit}" data-code="${i.code}" data-name="${i.name}">${i.code} - ${i.name} (${i.quantity} ${i.unit})</option>`).join('');
    }

    function updateItemPrice() {
        let itemSelect = document.getElementById('issue-item');
        let selected = itemSelect.options[itemSelect.selectedIndex];
        let price = selected.getAttribute('data-price') || 0;
        document.getElementById('issue-price').value = price;
        calculateIssueTotal();
    }

    function calculateIssueTotal() {
        let qty = parseFloat(document.getElementById('issue-qty').value) || 0;
        let price = parseFloat(document.getElementById('issue-price').value) || 0;
        document.getElementById('issue-total').value = qty * price;
    }

    function addMaterialIssue() {
        let date = document.getElementById('issue-date').value || new Date().toISOString().slice(0,10);
        let supervisor = document.getElementById('issue-sup').value;
        let project = document.getElementById('issue-proj').value;
        let warehouseId = document.getElementById('issue-warehouse').value;
        let itemSelect = document.getElementById('issue-item');
        let itemId = itemSelect.value;
        let qty = parseInt(document.getElementById('issue-qty').value);
        let price = parseFloat(document.getElementById('issue-price').value);
        let total = parseFloat(document.getElementById('issue-total').value);
        let desc = document.getElementById('issue-desc').value.trim() || 'ุตุฑู ููุงุฏ';
        if(!supervisor || !project || !warehouseId || !itemId || !qty || qty<=0) { alert('ุฃููู ุฌููุน ุงูุญููู'); return; }
        let item = db.inventoryItems.find(i => i.id == itemId);
        if(!item || item.quantity < qty) { alert('ุงููููุฉ ุบูุฑ ูุชููุฑุฉ'); return; }
        item.quantity -= qty;

        let issue = {
            id: Date.now(),
            date,
            supervisor,
            project,
            warehouseId: parseInt(warehouseId),
            itemId: item.id,
            itemCode: item.code,
            itemName: item.name,
            unit: item.unit,
            qty,
            price,
            total,
            desc
        };
        db.materialIssues.push(issue);
        saveToStorage();
        refreshAll();
        document.getElementById('issue-qty').value = '';
        document.getElementById('issue-desc').value = '';
        document.getElementById('issue-total').value = '';
        loadItemsForWarehouse();
    }

    function renderIssuesTable() {
        let tbody = document.getElementById('issues-list');
        if(!tbody) return;
        tbody.innerHTML = db.materialIssues.slice(-5).reverse().map((iss, idx) => {
            let index = db.materialIssues.indexOf(iss);
            return `<tr><td>${iss.date}</td><td>${iss.supervisor}</td><td>${iss.project}</td><td>${iss.itemCode} - ${iss.itemName}</td><td>${iss.qty} ${iss.unit}</td><td>${iss.total}</td><td><button class="btn btn-sm btn-outline-primary" onclick="printMaterialIssue(${index})"><i class="fas fa-print"></i></button></td></tr>`;
        }).join('');
    }

    function printMaterialIssue(index) {
        let issue = db.materialIssues[index];
        let warehouse = db.warehouses.find(w => w.id === issue.warehouseId);
        let whName = warehouse ? `${warehouse.code} - ${warehouse.name}` : '';
        let printContent = `<div style="direction:rtl; padding:20px"><h2 style="text-align:center">ูุงุชูุฑุฉ ุตุฑู ููุงุฏ</h2><hr><table style="width:100%"><tr><td>ุงูุชุงุฑูุฎ: ${issue.date}</td><td>ุฑูู ุงููุงุชูุฑุฉ: ${issue.id}</td></tr><tr><td>ุงููุดุฑู: ${issue.supervisor}</td><td>ุงููุดุฑูุน: ${issue.project}</td></tr><tr><td>ูุฎุฒู ุงูุตุฑู: ${whName}</td><td></td></tr></table><table border="1" style="width:100%; border-collapse:collapse; margin-top:20px"><thead><tr><th>ููุฏ ุงูุตูู</th><th>ุงุณู ุงูุตูู</th><th>ุงููุญุฏุฉ</th><th>ุงููููุฉ</th><th>ุงูุณุนุฑ</th><th>ุงูุฅุฌูุงูู</th></tr></thead><tbody><tr><td>${issue.itemCode}</td><td>${issue.itemName}</td><td>${issue.unit}</td><td>${issue.qty}</td><td>${issue.price}</td><td>${issue.total}</td></tr></tbody></table><p>ุงูุจูุงู: ${issue.desc}</p><hr><p style="text-align:left">ุงูุชูููุน: ________________</p></div>`;
        let printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>ูุงุชูุฑุฉ ุตุฑู</title></head><body>' + printContent + '</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    function printWarehouseBalance() {
        let content = '<div style="direction:rtl; padding:20px"><h2 style="text-align:center">ูุดู ุฑุตูุฏ ุงููุฎุงุฒู</h2><hr>';
        db.warehouses.forEach(wh => {
            content += `<h4>ุงููุฎุฒู: ${wh.code} - ${wh.name}</h4>`;
            let items = db.inventoryItems.filter(i => i.warehouseId === wh.id);
            if(items.length === 0) content += '<p>ูุง ุชูุฌุฏ ุฃุตูุงู</p>';
            else {
                content += '<table border="1" style="width:100%; border-collapse:collapse"><thead><tr><th>ุงูููุฏ</th><th>ุงูุตูู</th><th>ุงููุญุฏุฉ</th><th>ุงููููุฉ</th><th>ุงูุณุนุฑ</th><th>ุฅุฌูุงูู ุงููููุฉ</th></tr></thead><tbody>';
                items.forEach(i => { content += `<tr><td>${i.code}</td><td>${i.name}</td><td>${i.unit}</td><td>${i.quantity}</td><td>${i.price}</td><td>${i.quantity * i.price}</td></tr>`; });
                content += '</tbody></table>';
            }
        });
        content += '</div>';
        let printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>ูุดู ุฑุตูุฏ ุงููุฎุงุฒู</title></head><body>' + content + '</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    function printTransaction(type, index) {
        let item;
        if(type === 'voucher') item = db.vouchers[index];
        else if(type === 'expense') item = db.expenses[index];
        else if(type === 'invoice') item = db.invoices[index];
        else return;
        let content = `<div style="direction:rtl; padding:20px"><h2 style="text-align:center">ุชูุงุตูู ุงูุนูููุฉ</h2><hr>`;
        content += `<p><strong>ุงูุชุงุฑูุฎ:</strong> ${item.date}</p>`;
        content += `<p><strong>ุงูููุน:</strong> ${item.type || 'ูุณุชุฎูุต'}</p>`;
        if(type === 'voucher') {
            content += `<p><strong>ุงูุฌูุฉ:</strong> ${item.person}</p>`;
            content += `<p><strong>ุงููุดุฑูุน:</strong> ${item.project}</p>`;
            content += `<p><strong>ุงููุจูุบ:</strong> ${item.amount} ุฌ.ู</p>`;
            content += `<p><strong>ุงูุจูุงู:</strong> ${item.desc}</p>`;
        } else if(type === 'expense') {
            content += `<p><strong>ุงููุดุฑู:</strong> ${item.person}</p>`;
            content += `<p><strong>ุงููุดุฑูุน:</strong> ${item.project}</p>`;
            content += `<p><strong>ุงูุจูุฏ:</strong> ${item.item}</p>`;
            content += `<p><strong>ุงููุจูุบ:</strong> ${item.amount} ุฌ.ู</p>`;
            content += `<p><strong>ุงูุจูุงู:</strong> ${item.desc}</p>`;
        } else if(type === 'invoice') {
            content += `<p><strong>ุงููุดุฑูุน:</strong> ${item.project}</p>`;
            content += `<p><strong>ุฑูู ุงููุณุชุฎูุต:</strong> ${item.invNo}</p>`;
            content += `<p><strong>ูููุฉ ุงูุฃุนูุงู:</strong> ${item.amount} ุฌ.ู</p>`;
            content += `<p><strong>ุฎุตู ุชุฃููู:</strong> ${item.tamin} ุฌ.ู</p>`;
            content += `<p><strong>ุถุฑุงุฆุจ:</strong> ${item.tax} ุฌ.ู</p>`;
            content += `<p><strong>ุงูุตุงูู:</strong> ${item.net} ุฌ.ู</p>`;
            content += `<p><strong>ุญุงูุฉ ุงูุฏูุน:</strong> ${item.paid}</p>`;
        }
        content += `<hr><p style="text-align:left">ุงูุชูููุน: ________________</p></div>`;
        let printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>ุทุจุงุนุฉ ุนูููุฉ</title></head><body>' + content + '</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    // ==================== ุฏูุงู ุงูุชุฃุฌูุฑ (ููููุฉ) ====================
    function calculateEquipmentTotal() {
        let hours = parseFloat(document.getElementById('eq-hours').value) || 0;
        let rate = parseFloat(document.getElementById('eq-rate').value) || 0;
        document.getElementById('eq-total').value = (hours * rate).toFixed(2);
    }

    // ==================== ุฏูุงู ูุดู ุญุณุงุจ ุงููุดุฑู ====================
    function generateSupervisorStatement() {
        let supervisor = document.getElementById('stmt-supervisor').value;
        let fromDate = document.getElementById('stmt-from').value;
        let toDate = document.getElementById('stmt-to').value;

        if (!supervisor) {
            alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุดุฑู');
            return;
        }
        if (!fromDate || !toDate) {
            alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ูุงูููุงูุฉ');
            return;
        }
        if (fromDate > toDate) {
            alert('ุชุงุฑูุฎ ุงูุจุฏุงูุฉ ูุฌุจ ุฃู ูููู ูุจู ุชุงุฑูุฎ ุงูููุงูุฉ');
            return;
        }

        let received = db.vouchers.filter(v => 
            v.type === 'ุตุฑู ุนูุฏุฉ' && 
            v.person === supervisor && 
            v.date >= fromDate && 
            v.date <= toDate
        );

        let expenses = db.expenses.filter(e => 
            e.type === 'ูุตุฑูู ูุดุฑูุน' && 
            e.person === supervisor && 
            e.date >= fromDate && 
            e.date <= toDate
        );

        let totalReceived = received.reduce((sum, v) => sum + v.amount, 0);
        let totalExpenses = expenses.reduce((sum, e) => sum + e.amount, 0);
        let balance = totalReceived - totalExpenses;

        document.getElementById('stmt-sup-name').innerText = supervisor;
        document.getElementById('stmt-total-received').innerText = totalReceived.toFixed(2);
        document.getElementById('stmt-total-expenses').innerText = totalExpenses.toFixed(2);
        document.getElementById('stmt-balance').innerText = balance.toFixed(2);

        let details = [];
        received.forEach(v => {
            details.push({
                date: v.date,
                type: 'ุตุฑู ุนูุฏุฉ',
                project: v.project,
                desc: v.desc,
                amount: v.amount
            });
        });
        expenses.forEach(e => {
            details.push({
                date: e.date,
                type: 'ูุตุฑูู',
                project: e.project,
                desc: e.item + (e.desc ? ' - ' + e.desc : ''),
                amount: -e.amount
            });
        });

        details.sort((a, b) => (a.date > b.date) ? 1 : -1);

        let tbody = document.getElementById('stmt-details-body');
        tbody.innerHTML = details.map(d => `
            <tr>
                <td>${d.date}</td>
                <td>${d.type}</td>
                <td>${d.project}</td>
                <td>${d.desc}</td>
                <td class="${d.amount < 0 ? 'text-danger' : 'text-success'}">${d.amount.toFixed(2)}</td>
            </tr>
        `).join('');

        document.getElementById('statement-result').style.display = 'block';
    }

    function printSupervisorStatement() {
        let supervisor = document.getElementById('stmt-supervisor').value;
        let fromDate = document.getElementById('stmt-from').value;
        let toDate = document.getElementById('stmt-to').value;
        let totalReceived = document.getElementById('stmt-total-received').innerText;
        let totalExpenses = document.getElementById('stmt-total-expenses').innerText;
        let balance = document.getElementById('stmt-balance').innerText;
        let detailsRows = document.getElementById('stmt-details-body').innerHTML;

        let printContent = `
            <div style="direction:rtl; padding:20px">
                <h2 style="text-align:center">ูุดู ุญุณุงุจ ูุดุฑู</h2>
                <hr>
                <table style="width:100%">
                    <tr><td>ุงููุดุฑู: ${supervisor}</td><td>ูู ุชุงุฑูุฎ: ${fromDate}</td><td>ุฅูู ุชุงุฑูุฎ: ${toDate}</td></tr>
                </table>
                <div style="margin-top:20px">
                    <div style="background:#e8f4fd; padding:10px; border-radius:5px; margin-bottom:10px">
                        <strong>ุฅุฌูุงูู ุงูุนูุฏ:</strong> ${totalReceived} ุฌ.ู
                    </div>
                    <div style="background:#fde8e8; padding:10px; border-radius:5px; margin-bottom:10px">
                        <strong>ุฅุฌูุงูู ุงููุตุฑููุงุช:</strong> ${totalExpenses} ุฌ.ู
                    </div>
                    <div style="background:#e8fde8; padding:10px; border-radius:5px; margin-bottom:10px">
                        <strong>ุงูุฑุตูุฏ:</strong> ${balance} ุฌ.ู
                    </div>
                </div>
                <h4>ุชูุงุตูู ุงูุญุฑูุงุช</h4>
                <table border="1" style="width:100%; border-collapse:collapse">
                    <thead>
                        <tr>
                            <th>ุงูุชุงุฑูุฎ</th>
                            <th>ุงูููุน</th>
                            <th>ุงููุดุฑูุน</th>
                            <th>ุงูุจูุงู</th>
                            <th>ุงููุจูุบ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${detailsRows}
                    </tbody>
                </table>
                <hr>
                <p style="text-align:left">ุงูุชูููุน: ________________</p>
            </div>`;

        let printWindow = window.open('', '_blank');
        printWindow.document.write('<html><head><title>ูุดู ุญุณุงุจ ูุดุฑู</title></head><body>' + printContent + '</body></html>');
        printWindow.document.close();
        printWindow.print();
    }

    // ==================== ุฏูุงู ุชูุงููู ุงููุดุงุฑูุน ====================
    function addOperationalCost() {
        let project = document.getElementById('pc-project').value;
        let costType = document.getElementById('pc-cost-type').value;
        let date = document.getElementById('pc-date').value || new Date().toISOString().slice(0,10);
        let amount = parseFloat(document.getElementById('pc-amount').value);
        let desc = document.getElementById('pc-desc').value.trim();

        if (!project || !costType) {
            alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุดุฑูุน ูููุน ุงูุชูููุฉ');
            return;
        }
        if (isNaN(amount) || amount <= 0) {
            alert('ุฃุฏุฎู ูุจูุบ ุตุญูุญ');
            return;
        }

        let cost = {
            id: Date.now(),
            date: date,
            project: project,
            costType: costType,
            amount: amount,
            desc: desc || 'ุชูููุฉ ุชุดุบูู'
        };
        db.operationalCosts.push(cost);
        saveToStorage();
        refreshAll();
        document.getElementById('pc-date').value = '';
        document.getElementById('pc-amount').value = '';
        document.getElementById('pc-desc').value = '';
        alert('ุชู ุฅุถุงูุฉ ุชูููุฉ ุงูุชุดุบูู ุจูุฌุงุญ');
    }

    function addTax() {
        let project = document.getElementById('tax-project').value;
        let taxType = document.getElementById('tax-type').value;
        let date = document.getElementById('tax-date').value || new Date().toISOString().slice(0,10);
        let rate = parseFloat(document.getElementById('tax-rate').value);
        let base = parseFloat(document.getElementById('tax-base').value);
        let desc = document.getElementById('tax-desc').value.trim();

        if (!project || !taxType) {
            alert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ุงููุดุฑูุน ูููุน ุงูุถุฑูุจุฉ');
            return;
        }
        if (isNaN(rate) || rate < 0 || isNaN(base) || base <= 0) {
            alert('ุฃุฏุฎู ูุณุจุฉ ูุงูุฃุณุงุณ ุจุดูู ุตุญูุญ');
            return;
        }
        let amount = base * rate / 100;
        document.getElementById('tax-amount').value = amount.toFixed(2);

        let tax = {
            id: Date.now(),
            date: date,
            project: project,
            taxType: taxType,
            rate: rate,
            base: base,
            amount: amount,
            desc: desc || `ุถุฑูุจุฉ ${taxType}`
        };
        db.taxes.push(tax);
        saveToStorage();
        refreshAll();
        document.getElementById('tax-date').value = '';
        document.getElementById('tax-rate').value = '14';
        document.getElementById('tax-base').value = '';
        document.getElementById('tax-desc').value = '';
        document.getElementById('tax-amount').value = '';
        alert('ุชู ุฅุถุงูุฉ ุงูุถุฑูุจุฉ ุจูุฌุงุญ');
    }

    function renderProjectCosts() {
        let filterProject = document.getElementById('pc-filter-project').value;
        let tbody = document.getElementById('project-costs-body');
        if (!tbody) return;

        let allCosts = [];

        db.expenses.forEach(e => {
            if (e.type === 'ูุตุฑูู ูุดุฑูุน') {
                allCosts.push({
                    date: e.date,
                    project: e.project,
                    type: 'ูุตุฑูู',
                    details: e.item + (e.desc ? ' - ' + e.desc : ''),
                    amount: e.amount,
                    id: e.id,
                    category: 'expense'
                });
            }
        });

        db.operationalCosts.forEach(c => {
            allCosts.push({
                date: c.date,
                project: c.project,
                type: 'ุชุดุบูู - ' + c.costType,
                details: c.desc,
                amount: c.amount,
                id: c.id,
                category: 'operational'
            });
        });

        db.taxes.forEach(t => {
            allCosts.push({
                date: t.date,
                project: t.project,
                type: 'ุถุฑูุจุฉ - ' + t.taxType,
                details: t.desc + ` (${t.rate}% ูู ${t.base})`,
                amount: t.amount,
                id: t.id,
                category: 'tax'
            });
        });

        allCosts.sort((a, b) => (a.date < b.date) ? 1 : -1);

        if (filterProject) {
            allCosts = allCosts.filter(c => c.project === filterProject);
        }

        let total = 0;
        tbody.innerHTML = allCosts.map(c => {
            total += c.amount;
            let deleteFunc = '';
            if (c.category === 'expense') {
                let idx = db.expenses.findIndex(e => e.id === c.id);
                deleteFunc = `deleteTransaction('expense', ${idx})`;
            } else if (c.category === 'operational') {
                let idx = db.operationalCosts.findIndex(o => o.id === c.id);
                deleteFunc = `deleteOperationalCost(${idx})`;
            } else if (c.category === 'tax') {
                let idx = db.taxes.findIndex(t => t.id === c.id);
                deleteFunc = `deleteTax(${idx})`;
            }
            return `<tr>
                <td>${c.date}</td>
                <td>${c.project}</td>
                <td>${c.type}</td>
                <td>${c.details}</td>
                <td>${c.amount.toFixed(2)}</td>
                <td>
                    <i class="fas fa-trash text-danger action-icon" onclick="${deleteFunc}"></i>
                </td>
            </tr>`;
        }).join('');

        document.getElementById('total-project-costs').innerText = total.toFixed(2);
    }

    function deleteOperationalCost(index) {
        if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุชูููุฉ ุงูุชุดุบููุ')) return;
        db.operationalCosts.splice(index, 1);
        saveToStorage();
        refreshAll();
    }

    function deleteTax(index) {
        if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุถุฑูุจุฉุ')) return;
        db.taxes.splice(index, 1);
        saveToStorage();
        refreshAll();
    }

    // ==================== ุฏุงุดุจูุฑุฏ ====================
    function renderDashboard() {
        let cash = 0, float = 0, totalExp = 0, totalInv = 0, totalPaidInv = 0, totalRental = 0;
        db.vouchers.forEach(v => { if(v.type === 'ูุจุถ') cash += v.amount; else { cash -= v.amount; if(v.type === 'ุตุฑู ุนูุฏุฉ') float += v.amount; } });
        db.expenses.forEach(e => { float -= e.amount; totalExp += e.amount; });
        db.invoices.forEach(inv => { totalInv += inv.net; if(inv.paid === 'ูุฏููุน') totalPaidInv += inv.net; });
        db.equipmentRentals.forEach(r => { totalRental += r.total; });
        let totalOperational = db.operationalCosts.reduce((s, c) => s + c.amount, 0);
        let totalTaxes = db.taxes.reduce((s, t) => s + t.amount, 0);
        document.getElementById('stats-summary').innerHTML = `
            <div class="col-md-3"><div class="stat-box bg-primary"><h6>ุงูุฎุฒููุฉ</h6><h3>${cash.toLocaleString()} ุฌ.ู</h3></div></div>
            <div class="col-md-3"><div class="stat-box bg-warning"><h6>ุนููุฏ ุงููุดุฑููู</h6><h3>${float.toLocaleString()} ุฌ.ู</h3></div></div>
            <div class="col-md-3"><div class="stat-box bg-danger"><h6>ูุตุงุฑูู ุงููุดุงุฑูุน</h6><h3>${totalExp.toLocaleString()} ุฌ.ู</h3></div></div>
            <div class="col-md-3"><div class="stat-box bg-success"><h6>ุงููุณุชุฎูุตุงุช (ูุฏููุน)</h6><h3>${totalPaidInv.toLocaleString()} ุฌ.ู</h3><small>ุฅุฌูุงูู ${totalInv.toLocaleString()} ุฌ.ู</small></div></div>
            <div class="col-md-3 mt-2"><div class="stat-box bg-info"><h6>ุชุฃุฌูุฑ ูุนุฏุงุช</h6><h3>${totalRental.toLocaleString()} ุฌ.ู</h3></div></div>
            <div class="col-md-3 mt-2"><div class="stat-box bg-secondary"><h6>ุชูุงููู ุชุดุบูู</h6><h3>${totalOperational.toLocaleString()} ุฌ.ู</h3></div></div>
            <div class="col-md-3 mt-2"><div class="stat-box bg-dark"><h6>ุถุฑุงุฆุจ</h6><h3>${totalTaxes.toLocaleString()} ุฌ.ู</h3></div></div>`;
        let all = [...db.vouchers, ...db.expenses, ...db.invoices, ...db.materialIssues, ...db.purchases, ...db.equipmentRentals, ...db.operationalCosts, ...db.taxes].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
        document.getElementById('latest-transactions').innerHTML = all.map(t => `<tr><td>${t.date}</td><td>${t.type || (t.supplier ? 'ูุงุชูุฑุฉ ุดุฑุงุก' : t.equipmentType ? 'ุชุฃุฌูุฑ' : t.costType ? 'ุชูููุฉ ุชุดุบูู' : t.taxType ? 'ุถุฑูุจุฉ' : 'ุตุฑู ููุงุฏ')}</td><td>${t.amount || t.total || t.totalAmount || 0} ุฌ.ู</td></tr>`).join('');
        let ctx = document.getElementById('cashChart').getContext('2d');
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, { type: 'line', data: { labels: ['ุงูุฎุฒููุฉ', 'ุงูุนูุฏ', 'ุงููุตุงุฑูู', 'ุงููุณุชุฎูุตุงุช (ูุฏููุน)'], datasets: [{ label: 'ุงูููู (ุฌ.ู)', data: [cash, float, totalExp, totalPaidInv], backgroundColor: ['#3498db','#f39c12','#e74c3c','#27ae60'] }] } });
    }

    // ==================== ุฏูุงู ุฃุฎุฑู ====================
    function deleteMaterialIssue(index) {
        if(!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุนูููุฉ ุงูุตุฑูุ')) return;
        let issue = db.materialIssues[index];
        let item = db.inventoryItems.find(i => i.id === issue.itemId);
        if(item) item.quantity += issue.qty;
        db.materialIssues.splice(index, 1);
        saveToStorage();
        refreshAll();
    }

    function exportToExcel() {
        let all = [
            ...db.vouchers.map(v => ({ ...v, _type: v.type })),
            ...db.expenses.map(e => ({ ...e, _type: e.type })),
            ...db.invoices.map(i => ({ ...i, _type: 'ูุณุชุฎูุต' })),
            ...db.materialIssues.map(m => ({ ...m, _type: 'ุตุฑู ููุงุฏ', person: m.supervisor, amount: m.total })),
            ...db.purchases.map(p => ({ ...p, _type: 'ูุงุชูุฑุฉ ุดุฑุงุก', person: p.supplier, amount: p.totalAmount })),
            ...db.equipmentRentals.map(r => ({ ...r, _type: 'ุชุฃุฌูุฑ ูุนุฏุงุช', person: r.supervisor, amount: r.total })),
            ...db.operationalCosts.map(c => ({ ...c, _type: 'ุชูููุฉ ุชุดุบูู', person: '-', amount: c.amount })),
            ...db.taxes.map(t => ({ ...t, _type: 'ุถุฑูุจุฉ', person: '-', amount: t.amount }))
        ];
        let csv = "ุงูุชุงุฑูุฎ,ุงูููุน,ุงูุฌูุฉ,ุงููุดุฑูุน/ุงููุฎุฒู,ุงููุจูุบ (ุฌ.ู),ุงูุจูุงู,ุงูุญุงูุฉ\n";
        all.forEach(x => { 
            let type = x._type; 
            let person = x.person || x.supervisor || x.project || '-'; 
            let project = x.project || (x.warehouseId ? db.warehouses.find(w=>w.id==x.warehouseId)?.code : '-'); 
            let amount = x.amount || x.total || x.totalAmount || 0; 
            let desc = x.desc || x.item || x.notes || ''; 
            let status = x.paid ? x.paid : 'โ'; 
            csv += `${x.date},${type},${person},${project},${amount},${desc},${status}\n`; 
        });
        let blob = new Blob(["\uFEFF"+csv], {type: "text/csv;charset=utf-8;"});
        let link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "ุชูุฑูุฑ_ุงูุนูููุงุช.csv"; link.click();
    }

    function showPage(id) {
        document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => { if(l.getAttribute('onclick')?.includes(id)) l.classList.add('active'); });
        refreshAll();
        if(id==='dashboard') renderDashboard();
        if(id==='reports') renderReports();
        if(id==='expenses') initExpenseRows();
        if(id==='suppliersPage') renderSuppliersTable();
        if(id==='purchases') { initPurchaseRows(); }
        if(id==='equipment') {
            document.getElementById('eq-date').value = new Date().toISOString().slice(0,10);
        }
        if(id==='supervisorStatement') {
            document.getElementById('statement-result').style.display = 'none';
            let today = new Date();
            let firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().slice(0,10);
            document.getElementById('stmt-from').value = firstDay;
            document.getElementById('stmt-to').value = today.toISOString().slice(0,10);
        }
        if(id==='projectCosts') {
            document.getElementById('pc-date').value = new Date().toISOString().slice(0,10);
            document.getElementById('tax-date').value = new Date().toISOString().slice(0,10);
        }
        if(id==='equipmentStatement') {
            document.getElementById('equipment-statement-result').style.display = 'none';
            let today = new Date();
            let firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().slice(0,10);
            document.getElementById('stmt-eq-from').value = firstDay;
            document.getElementById('stmt-eq-to').value = today.toISOString().slice(0,10);
        }
    }

    window.onload = () => {
        let today = new Date().toISOString().slice(0,10);
        if(document.getElementById('v-date')) document.getElementById('v-date').value = today;
        if(document.getElementById('e-date')) document.getElementById('e-date').value = today;
        if(document.getElementById('i-date')) document.getElementById('i-date').value = today;
        if(document.getElementById('issue-date')) document.getElementById('issue-date').value = today;
        if(document.getElementById('p-date')) document.getElementById('p-date').value = today;
        if(document.getElementById('eq-date')) document.getElementById('eq-date').value = today;
        if(document.getElementById('pc-date')) document.getElementById('pc-date').value = today;
        if(document.getElementById('tax-date')) document.getElementById('tax-date').value = today;
        refreshAll();
        showPage('dashboard');
    };
</script>
</body>
</html>